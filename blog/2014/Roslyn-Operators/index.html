<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Adding crazily powerful operator overloading to C# 6 | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2014/Roslyn-Operators/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Adding crazily powerful operator overloading to C# 6</h1> <p class="post-meta"> Created on April 23, 2014 </p> <p class="post-tags"> <a href="/blog/2014"> <i class="fa-solid fa-calendar fa-sm"></i> 2014 </a>   ·   <a href="/blog/tag/roslyn"> <i class="fa-solid fa-hashtag fa-sm"></i> roslyn</a>   <a href="/blog/tag/c"> <i class="fa-solid fa-hashtag fa-sm"></i> c#</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><strong>I’m going to show you how to enable a new kind of operator overloading by adding exactly four (4) lines of code to a single file in the C# 6 compiler preview. Yes, I was surprised too!</strong></p> <p>After seeing the video of Anders Hejlsberg showing how easy it is to hack the new open source C# compiler, I had to give it a try.</p> <p>My aim was (I assumed) a lot more ambitious and crazy than his demo. I thought it would take ages to figure out. But it was still tempting to aim high and actually implement a substantial new feature, because there are a few I’ve been wondering about over the years.</p> <p>Ever since LINQ query syntax was added to the language, I’ve wished that operator overloading worked the same way. The <code class="language-plaintext highlighter-rouge">where</code> keyword gets turned into a call to a <code class="language-plaintext highlighter-rouge">Where</code> method. And it doesn’t matter where or how that method is defined. It can be an extension method, an ordinary method, a <code class="language-plaintext highlighter-rouge">virtual</code> method. In fact there are few other language features that map to well known member names: a collection initializer is turned into several calls to a method called <code class="language-plaintext highlighter-rouge">Add</code>, and the <code class="language-plaintext highlighter-rouge">await</code> keyword expands into calls to several methods.</p> <p>So my use case is very simple. Suppose I have a couple of sequences of values:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">nums1</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span> <span class="p">};</span>
<span class="kt">var</span> <span class="n">nums2</span> <span class="p">=</span> <span class="k">new</span><span class="p">[]</span> <span class="p">{</span> <span class="m">4</span><span class="p">,</span> <span class="m">5</span> <span class="p">};</span>

<span class="kt">var</span> <span class="n">nums3</span> <span class="p">=</span> <span class="n">nums1</span> <span class="p">+</span> <span class="n">nums2</span><span class="p">;</span>
</code></pre></div></div> <p>That last line, which I’d like to concatenate the two sequences, simply isn’t going to work because operator <code class="language-plaintext highlighter-rouge">+</code> is not defined on <code class="language-plaintext highlighter-rouge">IEnumerable</code>. Nor is there a way to make it work for all sequences in standard C#. That would require the ability to implement an operator overload using extension methods! Such a thing does not exist. But it would be pretty useful.</p> <p>Suppose if the compiler couldn’t find a standard meaning for <code class="language-plaintext highlighter-rouge">+</code>, it tried looking for a method available the left-hand-side value called <code class="language-plaintext highlighter-rouge">Addition</code>. (NB. <code class="language-plaintext highlighter-rouge">Add</code> is already taken by collection initializers as I previously noted).</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">EnumerableOperatorExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Addition</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">left</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">right</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">left</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="n">right</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Of course, <code class="language-plaintext highlighter-rouge">Concat</code> is already there to do the real work for us: the above incantation just makes it available under a standardised name.</p> <p>So let’s get to work. To play along at home, <a href="http://roslyn.codeplex.com/" rel="external nofollow noopener" target="_blank">download the Roslyn source</a>, read the <a href="http://roslyn.codeplex.com/wikipage?title=Building%2c%20Testing%20and%20Debugging&amp;referringTitle=Home" rel="external nofollow noopener" target="_blank">instructions for building/debugging</a>, get all the prerequisites (the instructions seem to be flawless as far as I can tell), and make sure you’re able to build and hit F5 to bring up Visual Studio. You’ll find you can set breakpoints and they will be hit (from multiple threads) as VS2013 compiles code on the fly as you edit it, to provide intellisense, etc.</p> <p>The first thing I had to do was find those well-known member names, such as <code class="language-plaintext highlighter-rouge">Where</code>. Obviously it wouldn’t be that easy, but I tried a simple search for the quoted string <code class="language-plaintext highlighter-rouge">"Where"</code>… Oh, turns out it really is that easy!</p> <p>This is the first hit:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">ReduceWhere</span><span class="p">(</span><span class="n">WhereClauseSyntax</span> <span class="k">where</span><span class="p">,</span> <span class="n">QueryTranslationState</span> <span class="n">state</span><span class="p">,</span> <span class="n">DiagnosticBag</span> <span class="n">diagnostics</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// A query expression with a where clause</span>
    <span class="c1">//     from x in e</span>
    <span class="c1">//     where f</span>
    <span class="c1">//     ...</span>
    <span class="c1">// is translated into</span>
    <span class="c1">//     from x in ( e ) . Where ( x =&gt; f )</span>
    <span class="kt">var</span> <span class="n">lambda</span> <span class="p">=</span> <span class="nf">MakeQueryUnboundLambda</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="nf">RangeVariableMap</span><span class="p">(),</span> <span class="n">state</span><span class="p">.</span><span class="n">rangeVariable</span><span class="p">,</span> <span class="k">where</span><span class="p">.</span><span class="n">Condition</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">invocation</span> <span class="p">=</span> <span class="nf">MakeQueryInvocation</span><span class="p">(</span><span class="k">where</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">fromExpression</span><span class="p">,</span> <span class="s">"Where"</span><span class="p">,</span> <span class="n">lambda</span><span class="p">,</span> <span class="n">diagnostics</span><span class="p">);</span>
    <span class="n">state</span><span class="p">.</span><span class="n">fromExpression</span> <span class="p">=</span> <span class="nf">MakeQueryClause</span><span class="p">(</span><span class="k">where</span><span class="p">,</span> <span class="n">invocation</span><span class="p">,</span> <span class="n">queryInvocation</span><span class="p">:</span> <span class="n">invocation</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>That <code class="language-plaintext highlighter-rouge">MakeQueryInvocation</code> looked intriguing. It calls onto another helper called <code class="language-plaintext highlighter-rouge">MakeInvocationExpression</code>, which takes a receiver for the method call, a method name and an immutable array of arguments, and is commented as:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Helper method to create a synthesized method invocation expression.</span>
</code></pre></div></div> <p>On searching for calls to it, as you’d expect, I found it being used for collection initializers and <code class="language-plaintext highlighter-rouge">await</code> in exactly the same way. All I needed was to find a spot in the binding of operators where we’re just about to give up and emit an error, and then try <code class="language-plaintext highlighter-rouge">MakeInvocationExpression</code>.</p> <p>The next part I did with a mixture of searching for likely words in the source and then setting breakpoints to see if they got hit. Eventually I found a method <code class="language-plaintext highlighter-rouge">Binder.BindSimpleBinaryOperator</code> in the file <code class="language-plaintext highlighter-rouge">Binder_Operator.cs</code>. Actually there are two overloads of it: the four-argument overload does the real work. (The two-argument overload is just a wrapper that avoids too much recursion when dealing with chained operators by implementing its own stack.)</p> <p>Anyway, it works by calling another helper, <code class="language-plaintext highlighter-rouge">BinaryOperatorOverloadResolution</code>, which implements the standard C# rules, and then it checks if it worked:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(!</span><span class="n">best</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">resultOperatorKind</span> <span class="p">=</span> <span class="n">kind</span><span class="p">;</span>
    <span class="n">resultType</span> <span class="p">=</span> <span class="nf">CreateErrorType</span><span class="p">();</span>
    <span class="n">hasErrors</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>That’s where it gives up! So that’s where we need <em>MOAR CODE</em>:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="p">(!</span><span class="n">best</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">string</span> <span class="n">methodName</span> <span class="p">=</span> <span class="n">Enum</span><span class="p">.</span><span class="nf">GetName</span><span class="p">(</span><span class="k">typeof</span><span class="p">(</span><span class="n">BinaryOperatorKind</span><span class="p">),</span> <span class="n">kind</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">methodCall</span> <span class="p">=</span> <span class="nf">MakeInvocationExpression</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">methodName</span><span class="p">,</span> <span class="n">ImmutableArray</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="n">right</span><span class="p">),</span> <span class="n">diagnostics</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">methodCall</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="p">!</span><span class="n">methodCall</span><span class="p">.</span><span class="n">HasAnyErrors</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">methodCall</span><span class="p">;</span>

    <span class="n">resultOperatorKind</span> <span class="p">=</span> <span class="n">kind</span><span class="p">;</span>
    <span class="n">resultType</span> <span class="p">=</span> <span class="nf">CreateErrorType</span><span class="p">();</span>
    <span class="n">hasErrors</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Look how damn lazy I was. The enum <code class="language-plaintext highlighter-rouge">BinaryOperatorKind</code> defines <code class="language-plaintext highlighter-rouge">Addition</code>, <code class="language-plaintext highlighter-rouge">Subtraction</code>, etc., so I just get the string name of the value to use as the method name. If <code class="language-plaintext highlighter-rouge">MakeInvocationExpression</code> seems to have worked, I return the result.</p> <p>But I was also quite careful. By ensuring the standard is followed first, and the new behaviour only kicks in for code that would otherwise be malformed, I don’t change the meaning of existing programs.</p> <p>And that’s it. Here’s a look at what happens in Visual Studio when I run it and enter my test case, but first <em>without</em> defining an extension method:</p> <p><img src="http://smellegantcode.files.wordpress.com/2014/04/roslyn1.jpg" alt="Errors"></p> <p>Note the error message! It’s telling us we need to write an <code class="language-plaintext highlighter-rouge">Addition</code> method that takes one argument. In the intellisense! I didn’t have to do anything in particular to make that happen.</p> <p>Then when we add the declaration of the extension method:</p> <p><img src="http://smellegantcode.files.wordpress.com/2014/04/roslyn2.jpg" alt="Fixed"></p> <p>The red squiggle has gone, and <code class="language-plaintext highlighter-rouge">num3</code> has the right type. And when I hit F5, I see the expected concatenated output.</p> <p>I am <em>astonished</em>.</p> <p><a href="https://roslyn.codeplex.com/SourceControl/network/forks/danielearwicker/roslynoperatormethods/changeset/e2c22d309f531ac7030782a124a9a8a41b18864b" rel="external nofollow noopener" target="_blank">Here’s a fork with this small change.</a></p> <p>There is still more to investigate. For example:</p> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">interface</span> <span class="nc">IThing</span>
<span class="p">{</span>
    <span class="n">IThing</span> <span class="nf">Addition</span><span class="p">(</span><span class="n">IThing</span> <span class="n">other</span><span class="p">);</span>
    <span class="n">IThing</span> <span class="nf">Subtraction</span><span class="p">(</span><span class="n">IThing</span> <span class="n">other</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">void</span> <span class="n">Test</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="n">b</span><span class="p">)</span> <span class="k">where</span> <span class="n">T</span> <span class="p">:</span> <span class="n">IThing</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">r1</span> <span class="p">=</span> <span class="n">a</span> <span class="p">+</span> <span class="n">b</span><span class="p">;</span>
    <span class="kt">var</span> <span class="n">r2</span> <span class="p">=</span> <span class="n">a</span> <span class="p">-</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>That works! Oh yes, you can do operators on generic parameter types. Couldn’t do that before.</p> <p>However, what about <code class="language-plaintext highlighter-rouge">==</code>? That doesn’t work - it seems the compiler handles equality comparison separately, and doesn’t get to my new code. Maybe that’s a good thing… But on the other hand, maybe not. Will take another look tomorrow.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai3/">Poorly Structured Notes on AI Part 3</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>