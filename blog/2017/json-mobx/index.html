<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> json-mobx - Like React, but for Data (Part 2) | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2017/json-mobx/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">json-mobx - Like React, but for Data (Part 2)</h1> <p class="post-meta"> Created on February 15, 2017 </p> <p class="post-tags"> <a href="/blog/2017"> <i class="fa-solid fa-calendar fa-sm"></i> 2017 </a>   ·   <a href="/blog/tag/mobx"> <i class="fa-solid fa-hashtag fa-sm"></i> MobX</a>   <a href="/blog/tag/react"> <i class="fa-solid fa-hashtag fa-sm"></i> react</a>   <a href="/blog/tag/json-mobx"> <i class="fa-solid fa-hashtag fa-sm"></i> json-mobx</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>This is a follow-on to <a href="../../2016/MobX">MobX - Like React, but for Data</a>, in which I noted the parallels between MobX and React.</p> <ul> <li>A <code class="language-plaintext highlighter-rouge">computed</code> “renders” a “view” of some data, and automatically updates when the source data changes. Like a React component, except generalised to cover any data, not just Virtual DOM.</li> <li>An <code class="language-plaintext highlighter-rouge">observable</code> is like the <code class="language-plaintext highlighter-rouge">setState</code> facility in stateful React components, except that its automatic ability to notify <code class="language-plaintext highlighter-rouge">computed</code> (and <code class="language-plaintext highlighter-rouge">autorun</code>) observers works by spooky “action at a distance” and so doesn’t have to take place inside one component.</li> </ul> <p>But this still leaves one major feature of React unaddressed, and that is <em>reconciliation</em>. What is this about, and how can it be useful in a more general way in MobX?</p> <h2 id="what-problem-does-reconciliation-solve">What problem does reconciliation solve?</h2> <p>Suppose you have some source data, which may change at any time, and you want to maintain a transformed variant of it. Whenever the source data changes, you need to update your variant. Stupid example: the source data is a list of numbers, and you want a list of strings containing those numbers:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span><span class="o">--</span> <span class="o">&gt;</span> <span class="p">[</span><span class="dl">"</span><span class="s2">1</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">3</span><span class="dl">"</span><span class="p">];</span>
</code></pre></div></div> <p>By far the easiest way to do this is to throw away the old list of strings and recreate it from scratch, every time the number list changes. This is what <a href="http://handlebarsjs.com" rel="external nofollow noopener" target="_blank">HTML templating systems</a> have long done, it’s what your React component’s <code class="language-plaintext highlighter-rouge">render</code> does, and it’s what <code class="language-plaintext highlighter-rouge">computed</code> does.</p> <p>The alternative, which is to identify the specific changes that have occurred in the input and poke corresponding specific changes into your output. This is hard - not in the above trival example, of course, but when the relationship between the input and output data is more complicated, it becomes almost a certainty that you’ll get something wrong and your output data will drift out of step with the input. Much easier to throw away and rebuild.</p> <p>By the way, it’s tempting to label these two approaches as “functional-immutable” and “imperative-mutable”. That would be a misunderstanding. The throw-away-and-rebuild approach does automatically avoid modifying old data (it discards it entirely), but the alternative can - and very often <em>is</em> - used in functional-immutable systems, to avoid cloning and discarding large complex data structures just because one little bit has changed. In fact it’s exactly what Redux does! Unfortunately, the resulting combination of responsibilities is even worse: you not only have to correctly translate changes in input to changes in output, but you then have to “ripple up” to the root as well. Like trying to tie a knot in a tightrope while you’re balancing on it. So this distinction isn’t relevant here: when we talk about updating some data, we could mean actually mutating or functional-style non-destructive updating.</p> <p>Okay, so what are the drawbacks of pure throw-away-and-rebuild? Well, we’re creating and throwing away a lot of objects. Could be a problem (always measure before worrying too much though). More pressingly, what if the output objects we build have extra degrees of freedom? By which I mean they have their own bits of state that can change <em>between</em> changes to the input?</p> <p>Drawing from the well of modern classics, let’s say my input is a list of string describing tasks to be done. The source data says what tasks exist. I want a list of <code class="language-plaintext highlighter-rouge">TodoItem</code> objects:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="dl">"</span><span class="s2">Bake bread</span><span class="dl">"</span><span class="p">,</span>            <span class="p">[</span><span class="k">new</span> <span class="nc">TodoItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">Bake bread</span><span class="dl">"</span><span class="p">),</span>
 <span class="dl">"</span><span class="s2">Impeach Trump</span><span class="dl">"</span><span class="p">,</span>   <span class="o">--&gt;</span>    <span class="k">new</span> <span class="nc">TodoItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">Impeach Trump</span><span class="dl">"</span><span class="p">),</span>
 <span class="dl">"</span><span class="s2">Cancel Brexit</span><span class="dl">"</span><span class="p">]</span>          <span class="k">new</span> <span class="nc">TodoItem</span><span class="p">(</span><span class="dl">"</span><span class="s2">Cancel Brexit</span><span class="dl">"</span><span class="p">)]</span>
</code></pre></div></div> <p>The interesting thing about <code class="language-plaintext highlighter-rouge">TodoItem</code>s is that they have a <code class="language-plaintext highlighter-rouge">completed</code> boolean, initially <code class="language-plaintext highlighter-rouge">false</code>. The input strings do not. At any time, I want to be able to toggle the <code class="language-plaintext highlighter-rouge">completed</code> boolean on any task, but also at any time the list of underlying strings may change.</p> <p>When that happens, I don’t want to lose the selection state of any surviving <code class="language-plaintext highlighter-rouge">TodoItem</code>s. But that’s what would happen if I used throw-away-and-rebuild. I would get a new set of <code class="language-plaintext highlighter-rouge">TodoItem</code>s in which <code class="language-plaintext highlighter-rouge">completed</code> is <code class="language-plaintext highlighter-rouge">false</code>.</p> <p>This is precisely the problem faced by React, and is far more important than concerns about performance, etc. A component can render complex stateful DOM elements, such as <code class="language-plaintext highlighter-rouge">&lt;video&gt;</code>, alongside simple things like a <code class="language-plaintext highlighter-rouge">&lt;span&gt;</code> showing the current playback time of the video clip. Each <code class="language-plaintext highlighter-rouge">render</code> must not throw away and discard the video player’s state, or your video would keep going back to the start every time the playback time ticked forward one second.</p> <p>The solution, which gives us the best of all worlds for zero effort, is reconciliation. Well, I say zero effort: once a general reconciliation system has been implemented by some library (such as React), we applications authors don’t have to lift a finger.</p> <p>And reconciliation means that we (the application authors) can write code that feels like throw-away-and-rebuild, “rendering” a specification of the desired state, but then the library takes care of making the minimum number of spot adjustments to the current state in order to bring it into line with our newly rendered specifications, taking care not to destroy associated data. In this case, we’d render the fact that we want a specific set of <code class="language-plaintext highlighter-rouge">TodoItem</code>s, and the library would add and delete actual <code class="language-plaintext highlighter-rouge">TodoItem</code> objects from the list accordingly.</p> <h2 id="approaches-to-serialization">Approaches to serialization</h2> <p>Now we’re going to take what appears to be a right-turn into another subject entirely. But it’s not!</p> <p>Serialization refers to any mechanism for turning a set of objects in memory into a flat stream suitable for storing (or sending over a wire) and later reassembling into another set of objects in memory. By far the most popular pattern for doing this has the following API:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">serializedStuff</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="nx">myObject</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">newObject</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">serializedStuff</span><span class="p">);</span>
</code></pre></div></div> <p>So it’s a way of <em>cloning an object</em>, via an intermediate representation that can be moved between processes. By “round-tripping” your object via some <code class="language-plaintext highlighter-rouge">serializedStuff</code>, you get a separate object that is a duplicate of the original.</p> <p>The MobX project itself <a href="https://github.com/mobxjs/serializr" rel="external nofollow noopener" target="_blank">hosts a fine implementation of this pattern</a>.</p> <p>This API earns “coolness” brownie points from the mere fact that it is pure. No objects are mutated in the making of this motion picture. And this does make it nice and simple. It also allows the type of the root object to vary freely.</p> <p>But consider an alternative API:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">serializedStuff</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="nx">myObject</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">newObject</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyClass</span><span class="p">();</span>
<span class="nx">api</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">newObject</span><span class="p">,</span> <span class="nx">serializedStuff</span><span class="p">);</span>
</code></pre></div></div> <p>This API accepts an object that it will mutate to make it match <code class="language-plaintext highlighter-rouge">serializedStuff</code>. In the example above the outcome is the same because I clone a new “blank” object to serve as the target. I can also deserialize back into the same object:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">oldVersion</span> <span class="o">=</span> <span class="nx">api</span><span class="p">.</span><span class="nf">save</span><span class="p">(</span><span class="nx">myObject</span><span class="p">);</span>

<span class="nx">myObject</span><span class="p">.</span><span class="nf">changeStuff</span><span class="p">();</span>

<span class="nx">api</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="nx">myObject</span><span class="p">,</span> <span class="nx">oldVersion</span><span class="p">);</span>
</code></pre></div></div> <p>So I can roll back an object to a previous state. The <code class="language-plaintext highlighter-rouge">load</code> implementation can be sophisticated. Where it’s dealing with a collection, it can minimize the changes it makes to only those required to honour the specification in <code class="language-plaintext highlighter-rouge">oldVersion</code>. Does this sound familiar?</p> <p>Yes, the <code class="language-plaintext highlighter-rouge">load</code> function is performing reconciliation. The <code class="language-plaintext highlighter-rouge">save</code> function is rendering a “virtual” object model (playing the roll of a <code class="language-plaintext highlighter-rouge">render</code> method), and the <code class="language-plaintext highlighter-rouge">load</code> function is reconciling <code class="language-plaintext highlighter-rouge">myObject</code> with that virtual object model.</p> <p>So this kind of serialization mechanism is the remaining piece of the React feature set.</p> <p>By the way, sophisticated serialization systems deal with things like proper graphs where two objects can refer to a third object and it takes care of serializing the third object only once. We’re not going to worry about that here; we’re only interested in simple tree-shaped object models.</p> <h2 id="mobx-state-tree">Mobx-state-tree</h2> <p>Another extremely interesting project-in-progress called <a href="https://github.com/mobxjs/mobx-state-tree" rel="external nofollow noopener" target="_blank">mobx-state-tree</a> is currently incubating in the MobX project. It is very different from MobX itself in that it mandates a much more restricted structure and even a style for constructing objects, and also its own kind of runtime-type metadata system. So it’s quite a big thing to bite into. But it has some very interesting features, particularly JSON patches.</p> <p>In this context the striking thing about it is this pair of linchpin functions in its API:</p> <ul> <li> <code class="language-plaintext highlighter-rouge">getSnapshot(model)</code>: returns a snapshot representing the current state of the model</li> <li> <code class="language-plaintext highlighter-rouge">applySnapshot(model, snapshot)</code>: updates the state of the model and all its descendants to the state represented by the snapshot</li> </ul> <p>Yep, <code class="language-plaintext highlighter-rouge">applySnapshot</code> is the <em>second</em> kind of <code class="language-plaintext highlighter-rouge">load</code> function. Does it perform reconciliation? e.g. what does <code class="language-plaintext highlighter-rouge">applySnapshot</code> do to an <a href="https://github.com/mobxjs/mobx-state-tree/blob/master/src/types/array.ts" rel="external nofollow noopener" target="_blank">array</a>?</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">action</span> <span class="nf">applySnapshot</span><span class="p">(</span><span class="nx">node</span><span class="p">:</span> <span class="nx">Node</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">snapshot</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// TODO: make a smart merge here, try to reuse instances..</span>
    <span class="nx">target</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="nx">snapshot</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>So yes, it looks like reconciliation is the eventual intention, even if it’s not there yet.</p> <p>In <a href="https://youtu.be/etnPDw5PKqg?t=44m40s" rel="external nofollow noopener" target="_blank">the introductory talk, at 44:40, Michel Weststrate</a> makes a fantastic point: give a class a <code class="language-plaintext highlighter-rouge">@computed</code> getter called <code class="language-plaintext highlighter-rouge">json</code> that returns its JSON representation, and then apply this concept consistently across all the classes and collections that comprise your state tree, and then suddenly you have a very efficient way of grabbing an immutable snapshot whenever you need one. Subsequent requests for the JSON of an object that hasn’t changed will return the same JSON structure without recomputing anything.</p> <p>This is <em>fantastic</em>. It means we can have the convenience of mutating the state tree wherever that makes sense (it very often does in a UI) but if we want regular immutable snapshots of the state then we can get them, and they are effectively costless, sharing unchanged parts with previous snapshots.</p> <p>And it means we already have the implementation of our <code class="language-plaintext highlighter-rouge">api.save(obj)</code> - it’s basically just: <code class="language-plaintext highlighter-rouge">obj =&gt; obj.json</code>. Okay, onward to <code class="language-plaintext highlighter-rouge">load</code>.</p> <h2 id="computed-properties-can-also-have-setters">Computed properties can also have setters!</h2> <p>Oh yes. Maybe not such a well known feature, but totally legit. Extending the example from Michel’s slide:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">observable</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">@</span><span class="nd">observable</span> <span class="nx">text</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="p">@</span><span class="nd">observable</span> <span class="nx">completed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="p">@</span><span class="nd">computed</span> <span class="kd">get</span> <span class="nf">json</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">id</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
            <span class="na">text</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span>
            <span class="na">completed</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">completed</span><span class="p">,</span>
        <span class="p">};</span>
    <span class="p">}</span>
    <span class="kd">set</span> <span class="nf">json</span><span class="p">(</span><span class="nx">data</span><span class="p">:</span> <span class="kr">any</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">id</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">text</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">completed</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">completed</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>Now this works both ways. And so <code class="language-plaintext highlighter-rouge">load(obj, data)</code> is basically <code class="language-plaintext highlighter-rouge">obj.json = data</code>.</p> <p>The only downer with this is that it’s going to be a pain writing classes where we have to list our properties three times: in the declaration, in the <code class="language-plaintext highlighter-rouge">get json</code> and in the <code class="language-plaintext highlighter-rouge">set json</code>. What a drag. So we could really use a decorator:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Todo</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">json</span> <span class="p">@</span><span class="nd">observable</span> <span class="nx">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">@</span><span class="nd">json</span> <span class="p">@</span><span class="nd">observable</span> <span class="nx">text</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span>
    <span class="p">@</span><span class="nd">json</span> <span class="p">@</span><span class="nd">observable</span> <span class="nx">completed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>This simply builds a <code class="language-plaintext highlighter-rouge">json</code> property, backed by a MobX <code class="language-plaintext highlighter-rouge">computed</code>, that does the equivalent of the above hand-written example. Now we’re really cooking.</p> <p>The drawback of this (and this is a general problem with decorators anyway) is that TypeScript doesn’t know that <code class="language-plaintext highlighter-rouge">Todo</code> has a <code class="language-plaintext highlighter-rouge">json</code> property. So for convenience we still need our <code class="language-plaintext highlighter-rouge">load</code>/<code class="language-plaintext highlighter-rouge">save</code> API, to perform a simple runtime check for the validity of the operation. I’ll call them <code class="language-plaintext highlighter-rouge">json.load</code> and <code class="language-plaintext highlighter-rouge">json.save</code> to clarify that they operate on the <code class="language-plaintext highlighter-rouge">json</code> property of objects. I’m not hugely troubled by strict type safety in serialization formats because, theoretically cool as it is, usually we evolve the format over time anyway.</p> <p>Anyway, this establishes a general pattern. Wherever we need to finely control how an object is represented in JSON - or <em>how it reconciles itself with some JSON instructions</em> - we can just give it a custom <code class="language-plaintext highlighter-rouge">@computed json</code> property. So with this one concept, any kind of extension or reusable utility can be added. This means we don’t actually need a separate type metadata system. It’s a lot thinner and more lightweight than the full mobx-state-tree implementation - less ambitious - but it means I can start using it right now and know that I’ll never get stuck.</p> <p>Okay, so clearly I’ve put this on <a href="https://github.com/danielearwicker/json-mobx" rel="external nofollow noopener" target="_blank">github</a> and <a href="https://www.npmjs.com/package/json-mobx" rel="external nofollow noopener" target="_blank">npm</a>.</p> <h2 id="arrays-and-identifiers">Arrays and identifiers</h2> <p>Initially I included a <code class="language-plaintext highlighter-rouge">Collection</code> class that wrapped an array and implemented <code class="language-plaintext highlighter-rouge">json</code> to serialize it. This worked, but added some verbosity in regular usage. <a href="https://github.com/mrjjwright" rel="external nofollow noopener" target="_blank">John Wright</a> suggested building in support for arrays, and this made a lot of sense.</p> <p>This is very much a <code class="language-plaintext highlighter-rouge">MobX</code>-based library (<code class="language-plaintext highlighter-rouge">json</code> is always <code class="language-plaintext highlighter-rouge">@computed</code>), and clearly we need arrays to be observable in order to correctly update the JSON representation whenever the array changes. Therefore we extend observable arrays by adding a <code class="language-plaintext highlighter-rouge">json</code> property to them. To construct such an enhanced array, we provide <code class="language-plaintext highlighter-rouge">json.array</code>:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TodoStore</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">json</span> <span class="nx">todos</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">array</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nc">Todo</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div></div> <p>What’s the parameter for? It’s so that the array knows how to construct a new item whenever it needs to, during reconciliation. In fact there’s a shorter version for where the item can be new-constructed with no parameters:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TodoStore</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">json</span> <span class="nx">todos</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">arrayOf</span><span class="p">(</span><span class="nx">Todo</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>In React the reconciliation process relies on each item in a list having a <code class="language-plaintext highlighter-rouge">key</code> prop that is unique-valued within the list. It’s exactly the same here, except that the unique valued property is called <code class="language-plaintext highlighter-rouge">&lt;id&gt;</code>. Another difference is that <em>you don’t have to assign it</em>. The library takes care of associating a unique (short) number identifier to your objects, and then saving it in the JSON representation so that it can be matched up in future reconciliations.</p> <p>This means we can go ahead and rip the <code class="language-plaintext highlighter-rouge">id</code> property out of the <code class="language-plaintext highlighter-rouge">Todo</code> class. We don’t need one. Reconciliation will work fine, regardless.</p> <p>On the other hand, we might want to retain it and use a meaningful ID (say, from a database system) or a natural key from the data. If so, we can tell <code class="language-plaintext highlighter-rouge">json.array</code> to use our ID property instead:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">TodoStore</span> <span class="p">{</span>
    <span class="p">@</span><span class="nd">json</span> <span class="nx">todos</span> <span class="o">=</span> <span class="nx">json</span><span class="p">.</span><span class="nf">arrayOf</span><span class="p">(</span><span class="nx">Todo</span><span class="p">,</span> <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>The second parameter’s type is <code class="language-plaintext highlighter-rouge">keyof T</code> (a feature added in TypeScript 2.1), so it has to be the name of a property in the array’s item type.</p> <h2 id="undo-oh-and-dont-forget-redo">Undo (oh, and don’t forget Redo)</h2> <p>The oft-claimed unique advantage of Redux, and indeed anything based on immutable data, is that your app gets an undo feature “for free”. The truth of this depends on whether you regard the boilerplate overhead of Redux as “free”.</p> <p>But anyway, now we have effortless reconciliation and efficient snapshots, we can achieve precisely the same thing. Also because MobX already has built-in transactional updating, we can do things like batch up several operations into a single Undo/Redo step.</p> <p>This is such a win for this pattern that I’ve included an <code class="language-plaintext highlighter-rouge">Undo</code> class in the library itself. <a href="https://github.com/danielearwicker/json-mobx/blob/master/src/Undo.ts" rel="external nofollow noopener" target="_blank">The implementation is very short</a> but it has a subtlety.</p> <p>You construct it passing the root model object of your state tree.</p> <p>The <code class="language-plaintext highlighter-rouge">enabled</code> property is <code class="language-plaintext highlighter-rouge">false</code> to begin with. An <code class="language-plaintext highlighter-rouge">autorun</code> is created in the constructor that therefore runs immediately. On this first run it just captures the current state snapshot and sets <code class="language-plaintext highlighter-rouge">enabled</code> to <code class="language-plaintext highlighter-rouge">true</code>.</p> <p>This means that when the state tree changes, the handler runs again and this time <code class="language-plaintext highlighter-rouge">enabled</code> is true, and it pushes the previously captured state to the <code class="language-plaintext highlighter-rouge">undoStack</code>.</p> <p>The <code class="language-plaintext highlighter-rouge">enabled</code> property comes into play again when we need to execute the <code class="language-plaintext highlighter-rouge">undo</code> or <code class="language-plaintext highlighter-rouge">redo</code> actions (which are probably tied to some buttons in the UI). These are mutually symmetrical with respect to the two stacks: you pop from one stack to get the new current state, and you push the old current state onto the other stack. But before loading the new current state into the model, you set <code class="language-plaintext highlighter-rouge">enabled</code> to be false, to avoid interfering with the <code class="language-plaintext highlighter-rouge">undoStack</code>.</p> <p>So there’s your optimal, super easy undo/redo system, and it really is “for free”. Just put <code class="language-plaintext highlighter-rouge">@json</code> on the stuff you want to record.</p> <h2 id="what-about-polymorphism">What about polymorphism?</h2> <p>I’ve written up how this works in the README, but it should by now come as no surprise that we solve the problem of mixed object types appearing on the same array by defining a <code class="language-plaintext highlighter-rouge">@computed json</code> property that takes care of it in a very simple way.</p> <p>Have fun!</p> <p>Those links again:</p> <ul> <li><a href="https://github.com/danielearwicker/json-mobx" rel="external nofollow noopener" target="_blank">json-mobx on github</a></li> <li><a href="https://www.npmjs.com/package/json-mobx" rel="external nofollow noopener" target="_blank">json-mobx on npm</a></li> </ul> <p>And for a working example, take a look at:</p> <ul> <li><a href="https://github.com/danielearwicker/baltar" rel="external nofollow noopener" target="_blank">baltar</a></li> </ul> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Java-Csharp/">Language Smackdown: Java vs. C#</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>