<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> TypeScript multicast functions | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2016/TypeScript-multicast/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">TypeScript multicast functions</h1> <p class="post-meta"> Created on March 13, 2016 </p> <p class="post-tags"> <a href="/blog/2016"> <i class="fa-solid fa-calendar fa-sm"></i> 2016 </a>   ·   <a href="/blog/tag/typescript"> <i class="fa-solid fa-hashtag fa-sm"></i> typescript</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Just as in JavaScript, C# functions are first class entities - you can pass them around in variables. There are two ways that C# differs from JavaScript.</p> <ol> <li> <p>a method’s <code class="language-plaintext highlighter-rouge">this</code> reference is automatically bound to the object it belongs to. In JS a “method” is just an object property that happens to contain a function. If copied into a separate variable and then called, there may or may not be a problem depending on whether the function internally refers to <code class="language-plaintext highlighter-rouge">this</code>.</p> </li> <li> <p>a function value (known as a “delegate”) has operators <code class="language-plaintext highlighter-rouge">+</code>, <code class="language-plaintext highlighter-rouge">-</code>, <code class="language-plaintext highlighter-rouge">+=</code>, <code class="language-plaintext highlighter-rouge">-=</code> that allow it to be combined with other compatible functions to create a new single function that, when invoked, causes the constituent functions to be invoked.</p> </li> </ol> <p>The second one is what I’m interested in today, mainly because it’s a nice example of something that we can strongly type check in TypeScript. Internally (at the “plumbing” level) we have to bypass type checks, but externally we can guarantee everything will work.</p> <p><a href="https://github.com/danielearwicker/multicast" rel="external nofollow noopener" target="_blank">Browse the source code</a></p> <p>A <code class="language-plaintext highlighter-rouge">multicast&lt;TFunc&gt;</code> is a function whose type is the intersection of <code class="language-plaintext highlighter-rouge">TFunc</code> and some methods called <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">remove</code>. To declare it, we have to say:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Subscribable</span><span class="o">&lt;</span><span class="nx">TFunc</span> <span class="kd">extends</span> <span class="nb">Function</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nf">add</span><span class="p">(</span><span class="na">handler</span><span class="p">:</span> <span class="nx">TFunc</span><span class="p">):</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="nf">remove</span><span class="p">(</span><span class="na">handler</span><span class="p">:</span> <span class="nx">TFunc</span><span class="p">):</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span> <span class="kd">extends</span> <span class="nb">Function</span><span class="o">&gt;</span> <span class="o">=</span> <span class="nx">Subscribable</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="nx">TFunc</span><span class="p">;</span>
</code></pre></div></div> <p>This is a neat trick, but it seems odd that we can’t say:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span> <span class="kd">extends</span> <span class="nb">Function</span><span class="o">&gt;</span> <span class="kd">extends</span> <span class="nx">TFunc</span> <span class="p">{</span>
    <span class="nf">add</span><span class="p">(</span><span class="nx">handler</span><span class="p">:</span> <span class="nx">TFunc</span><span class="p">):</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span><span class="p">;</span>
    <span class="nf">remove</span><span class="p">(</span><span class="nx">handler</span><span class="p">:</span> <span class="nx">TFunc</span><span class="p">):</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>TypeScript currently won’t let an interface extend one of its type parameters. But the first snippet achieves the same thing by roundabout means, so it seems to be just a curious historical limitation and maybe it will be lifted in a future version of the compiler (it’s evolving so fast).</p> <p>In short, the <code class="language-plaintext highlighter-rouge">&amp;</code> operator (“intersection of types”) allows two types to be merged: it outputs a type that has the capabilities of both input types. This is a vague way of saying it, and it makes “intersection” seem like the wrong name: an intersection is the (usually smaller) subset of items common to two (usually larger) sets. It’s the little bit that overlaps. And yet here we’re making a type that is “bigger” than the two inputs. To be more precise we need to do exactly the same mental switcheroo I described in <a href="../../2015/TypeScript-Superset/">TypeScript is not really a superset of JavaScript and that is a Good Thing</a>: a type can be thought of as the set of values that are of that type. Thinking of it that way, only a subset of the values of type <code class="language-plaintext highlighter-rouge">A</code> will also be values of type <code class="language-plaintext highlighter-rouge">B</code>. So we are indeed talking about an intersection: of two sets of <em>values</em>.</p> <p>The end product is a function that, as well as being directly callable, also has a couple of methods, <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">remove</code>, tacked onto it. Note that they each return a <code class="language-plaintext highlighter-rouge">Multicast</code> of exactly the same type; this is because (like C# delegates) I’ve made them immutable: you can’t change what’s on the list of an existing <code class="language-plaintext highlighter-rouge">Multicast</code>, but you can get a new <code class="language-plaintext highlighter-rouge">Multicast</code> with whatever alteration you require.</p> <p>The implementation works by defining an object that implements <code class="language-plaintext highlighter-rouge">Subscribable</code>, and then “merging” it onto a forwarding function.</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nf">multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span> <span class="kd">extends</span> <span class="nb">Function</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="p">...</span><span class="nx">handlers</span><span class="p">:</span> <span class="nx">TFunc</span><span class="p">[]</span>
<span class="p">):</span> <span class="nx">Multicast</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nx">handlers</span> <span class="o">=</span> <span class="nx">handlers</span><span class="p">;</span>

    <span class="kd">const</span> <span class="na">subscribable</span><span class="p">:</span> <span class="nx">Subscribable</span><span class="o">&lt;</span><span class="nx">TFunc</span><span class="o">&gt;</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nf">add</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">multicast</span><span class="p">(...</span><span class="nx">handlers</span><span class="p">.</span><span class="nf">concat</span><span class="p">(</span><span class="nx">handler</span><span class="p">));</span>
        <span class="p">},</span>
        <span class="nf">remove</span><span class="p">(</span><span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nf">multicast</span><span class="p">(...</span><span class="nx">handlers</span><span class="p">.</span><span class="nf">filter</span><span class="p">((</span><span class="nx">h</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">h</span> <span class="o">!==</span> <span class="nx">handler</span><span class="p">));</span>
        <span class="p">},</span>
    <span class="p">};</span>

    <span class="kd">const</span> <span class="na">invoke</span><span class="p">:</span> <span class="nx">TFunc</span> <span class="o">=</span> <span class="p">((...</span><span class="na">args</span><span class="p">:</span> <span class="kr">any</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="na">result</span><span class="p">:</span> <span class="kr">any</span><span class="p">;</span>
        <span class="nx">handlers</span><span class="p">.</span><span class="nf">forEach</span><span class="p">((</span><span class="nx">handler</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span><span class="nx">result</span> <span class="o">=</span> <span class="nx">handler</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">args</span><span class="p">)));</span>
        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">})</span> <span class="kd">as </span><span class="kr">any</span><span class="p">;</span>

    <span class="k">return</span> <span class="nf">merge</span><span class="p">(</span><span class="nx">invoke</span><span class="p">,</span> <span class="nx">subscribable</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Note the two different uses of the <a href="https://basarat.gitbooks.io/typescript/content/docs/spread-operator.html" rel="external nofollow noopener" target="_blank">spread operator</a>. First for handlers (you can pass any number of compatible functions as arguments to <code class="language-plaintext highlighter-rouge">multicast</code> to get them all joined together), and this lets us do immutable array manipulation (<code class="language-plaintext highlighter-rouge">concat</code>, <code class="language-plaintext highlighter-rouge">filter</code>) to create further calls to <code class="language-plaintext highlighter-rouge">multicast</code> when implementing <code class="language-plaintext highlighter-rouge">add</code> and <code class="language-plaintext highlighter-rouge">remove</code>.</p> <p>Second, the ugly part: <code class="language-plaintext highlighter-rouge">invoke</code>. This is the basis of the function object we will return. It is basically completely untypechecked (note the <code class="language-plaintext highlighter-rouge">as any</code>!) But at the same time, it implements <code class="language-plaintext highlighter-rouge">TFunc</code> by calling on to handlers that implement <code class="language-plaintext highlighter-rouge">TFunc</code>, so it is type safe.</p> <p>Note how discards all but the last return value. It would be nice if we could specify a custom reducer function:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nx">a</span><span class="p">:</span> <span class="nx">TReturn</span><span class="p">,</span> <span class="nx">b</span><span class="p">:</span> <span class="nx">TReturn</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">TReturn</span><span class="p">;</span>
</code></pre></div></div> <p>That would allow the user to request that return values should be summed, etc.</p> <p>But TypeScript doesn’t give us a way to find out the return type of a function type. It would be really powerful if we could discover “traits” about a type (a C++ idea) like that. Another example would be getting a tuple type of the parameters to a function type. And what if we could construct a new function type out of such pieces? Then we could do things like wrapping the return type in a promise. This would be useful for solving problems like making a promise-enabled version of any node.js style callback API. But I digress.</p> <p>One final piece of the implementation is the <code class="language-plaintext highlighter-rouge">merge</code> call right at the end. This is the classic:</p> <div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nf">merge</span><span class="o">&lt;</span><span class="nx">T1</span><span class="p">,</span> <span class="nx">T2</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">onto</span><span class="p">:</span> <span class="nx">T1</span><span class="p">,</span> <span class="k">from</span><span class="p">:</span> <span class="nx">T2</span><span class="p">):</span> <span class="nx">T1</span> <span class="o">&amp;</span> <span class="nx">T2</span> <span class="p">{</span>
    <span class="k">if </span><span class="p">(</span><span class="k">typeof</span> <span class="k">from</span> <span class="o">!==</span> <span class="dl">"</span><span class="s2">object</span><span class="dl">"</span> <span class="o">||</span> <span class="k">from</span> <span class="k">instanceof</span> <span class="nb">Array</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">merge: 'from' must be an ordinary object</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="nb">Object</span><span class="p">.</span><span class="nf">keys</span><span class="p">(</span><span class="k">from</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span>
        <span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">((</span><span class="nx">onto</span> <span class="kd">as </span><span class="kr">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="k">from</span> <span class="kd">as </span><span class="kr">any</span><span class="p">)[</span><span class="nx">key</span><span class="p">])</span>
    <span class="p">);</span>
    <span class="k">return</span> <span class="nx">onto</span> <span class="kd">as </span><span class="nx">T1</span> <span class="o">&amp;</span> <span class="nx">T2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>As you can see, even this is not without its subtleties. It is a mutating operation (ugh) but that’s because it’s a low-level building block. It copies the properties of its second parameter onto its first. As long as the second parameter is a simple object then this is sufficient to make the first parameter gain the type of the second, thus honouring our claim to be returning <code class="language-plaintext highlighter-rouge">T1 &amp; T2</code>. But there isn’t (as far as I know) a way to specify that <code class="language-plaintext highlighter-rouge">T2</code> must be a simple object in that sense, hence the runtime check. The user might pass two functions, for example. That’s no good, as merging two functions can be a tricky problem even when you know what parameters they accept; if they could be <em>any</em> old functions then you are out of luck. JavaScript functions don’t have “typed” parameters, so how can you decide which of the two input functions to dispatch a call to? Given this, <a href="https://github.com/Microsoft/TypeScript/issues/7494" rel="external nofollow noopener" target="_blank">I wonder why it is even possible</a> for <code class="language-plaintext highlighter-rouge">A &amp; B</code> to get past the compiler if both <code class="language-plaintext highlighter-rouge">A</code> and <code class="language-plaintext highlighter-rouge">B</code> are functions.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Java-Csharp/">Language Smackdown: Java vs. C#</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>