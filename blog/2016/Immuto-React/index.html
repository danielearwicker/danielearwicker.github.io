<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Immuto - Working with React (An Example) | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2016/Immuto-React/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Immuto - Working with React (An Example)</h1> <p class="post-meta"> Created on September 16, 2016 </p> <p class="post-tags"> <a href="/blog/2016"> <i class="fa-solid fa-calendar fa-sm"></i> 2016 </a>   ·   <a href="/blog/tag/typescript"> <i class="fa-solid fa-hashtag fa-sm"></i> typescript</a>   <a href="/blog/tag/immuto"> <i class="fa-solid fa-hashtag fa-sm"></i> immuto</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><em>UPDATE - I’m in the move-fast-and-break-things phase so a couple of details in here are already out of date. In particular, properties are now unified with cursors. See the various repos for details.</em></p> <p>In <a href="../Immuto">Immuto - Strongly Typed Redux Composition</a> I introduced the <a href="https://github.com/danielearwicker/immuto" rel="external nofollow noopener" target="_blank">Immuto library</a> by coyly describing a wish-list of features, as if I hadn’t already written the darn thing. Shucks!</p> <p>What I didn’t do was show how to make a working UI in React, using Immuto to define all the actions and the structure of the store. The missing piece is another package:</p> <ul> <li><code class="language-plaintext highlighter-rouge">npm install immuto-react</code></li> </ul> <p>However, the majority of this document is just plain <code class="language-plaintext highlighter-rouge">immuto</code> used in conjunction with <code class="language-plaintext highlighter-rouge">react</code>. We won’t need <code class="language-plaintext highlighter-rouge">immuto-react</code> until the very last step.</p> <p>Also there is nothing DOM-specific at all. This should all work with React Native, or in server-side rendering, or what-have-you.</p> <h2 id="example-app">Example app</h2> <p>There’s a running example here:</p> <ul> <li><a href="https://danielearwicker.github.io/resources/immuto">Live demo</a></li> </ul> <p>The source is here:</p> <ul> <li><a href="https://github.com/danielearwicker/immuto-example" rel="external nofollow noopener" target="_blank">immuto-example</a></li> </ul> <p>Clone it and get it running like this:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/danielearwicker/immuto-example
<span class="nb">cd </span>immuto-example
npm <span class="nb">install
</span>webpack
http-server
</code></pre></div></div> <p>You’ll need to global install the last two tools from <code class="language-plaintext highlighter-rouge">npm</code> also if you don’t have them already. When it’s up and running you can hit <code class="language-plaintext highlighter-rouge">localhost:8080</code>.</p> <p>In the TypeScript editor of your choice (I’ve been using <code class="language-plaintext highlighter-rouge">alm</code> recently, because AWESOME) one neat thing to look at is <code class="language-plaintext highlighter-rouge">exampleData.ts</code> <a href="https://github.com/danielearwicker/immuto-example/blob/master/exampleData.ts" rel="external nofollow noopener" target="_blank">(link)</a>. It first glance it looks like a pretty boring copy/paste of a JSON log of actions. Which is what it is. Maybe I just like boring stuff?</p> <p>But what’s really cool is that if you edit the <code class="language-plaintext highlighter-rouge">type</code> property of any action, including the nested ones, or change a payload from a string to a number, TypeScript starts moaning. It’s type-checking the shizzle out of it. Every action in the log is of type <code class="language-plaintext highlighter-rouge">typeof Shop.reduce.actionType</code>. This means that if I restructure the app, changing even the slightest detail of the actions supported by my reducers, TypeScript pipes up and says “You need to update your example data!”</p> <p>It’s a neat demonstration of how the deep the type checking goes in Immuto. It doesn’t just rely on you going through a special API. Even if you hand-build your actions, they can (if you wish) be fully validated at compile time. I know I shouldn’t be surprised by this, having designed it to work this way from the ground up, but I genuinely did change the type string of one of my actions and TypeScript <em>did at once</em> tell me to fix the example data, making me say “Well, I’ll be a monkey’s uncle” or similar earthy reflexive sobriquet.</p> <h2 id="two-way-binding-inconceivable">Two-Way Binding? Inconceivable!</h2> <p>I’ve continued with the book/shelf/shop theme. Let’s start with the simplest piece, the <code class="language-plaintext highlighter-rouge">Book</code> (slightly simplified):</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Book</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>Of course I like to gather related useful stuff for a type in a namespace with the same name:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nx">Book</span> <span class="p">{</span>
    <span class="k">export</span> <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span><span class="dl">"</span><span class="s2">TITLE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">price</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span><span class="dl">"</span><span class="s2">PRICE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">price</span><span class="p">);</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">empty</span><span class="p">:</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">price</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">authors</span><span class="p">:</span> <span class="p">[]</span> <span class="p">};</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nx">reducer</span><span class="o">&lt;</span><span class="nx">Book</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">empty</span><span class="p">).</span><span class="nf">action</span><span class="p">(</span><span class="nx">title</span><span class="p">).</span><span class="nf">action</span><span class="p">(</span><span class="nx">price</span><span class="p">);</span>

    <span class="k">export</span> <span class="kd">type</span> <span class="nx">Cursor</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">reduce</span><span class="p">.</span><span class="nx">cursorType</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>And here’s a really minimal component that lets the user edit a book:</p> <div class="language-tsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">BookEditor</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">book</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">Cursor</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nc">TextInput</span> <span class="na">property</span><span class="p">=</span><span class="si">{</span><span class="nx">Book</span><span class="p">.</span><span class="nf">title</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span>
        <span class="p">&lt;</span><span class="nc">DecimalInput</span> <span class="na">property</span><span class="p">=</span><span class="si">{</span><span class="nx">Book</span><span class="p">.</span><span class="nf">price</span><span class="p">(</span><span class="nx">book</span><span class="p">)</span><span class="si">}</span> <span class="na">decimalPlaces</span><span class="p">=</span><span class="si">{</span><span class="mi">2</span><span class="si">}</span> <span class="p">/&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div></div> <p>This looks a lot like “two-way binding”, and so it is, but it’s all layered over pure Redux actions that are submitted to a single store. And yet nothing in that definition has been bound to a specific store at this stage. It’s a perfectly reusable component.</p> <p><code class="language-plaintext highlighter-rouge">TextInput</code> and <code class="language-plaintext highlighter-rouge">DecimalInput</code> are components that wrap the <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> element. They both take a prop called <code class="language-plaintext highlighter-rouge">property</code>, which can be anything conforming to this extremely simple interface:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Property</span><span class="o">&lt;</span><span class="nx">P</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="na">state</span><span class="p">:</span> <span class="nx">P</span><span class="p">;</span>
    <span class="p">(</span><span class="na">newValue</span><span class="p">:</span> <span class="nx">P</span><span class="p">):</span> <span class="k">void</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>That is, a function that can be passed a new value, and the function also has a property <code class="language-plaintext highlighter-rouge">state</code> containing the current value. And so a minimal definition of <code class="language-plaintext highlighter-rouge">TextInput</code> would be:</p> <div class="language-tsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">TextInput</span><span class="p">({</span> <span class="nx">property</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">property</span><span class="p">:</span> <span class="nx">Property</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span> <span class="p">})</span> <span class="p">{</span>
    <span class="k">return </span><span class="p">(</span>
        <span class="p">&lt;</span><span class="nt">input</span>
            <span class="na">type</span><span class="p">=</span><span class="s">"text"</span>
            <span class="na">value</span><span class="p">=</span><span class="si">{</span><span class="nx">property</span><span class="p">.</span><span class="nx">state</span><span class="si">}</span>
            <span class="na">onChange</span><span class="p">=</span><span class="si">{</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">property</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">currentTarget</span><span class="p">.</span><span class="nx">value</span><span class="p">)</span><span class="si">}</span>
        <span class="p">/&gt;</span>
    <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>As you can see, it wouldn’t be that much bother to use <code class="language-plaintext highlighter-rouge">&lt;input&gt;</code> directly. But text input fields are pretty commonplace and so why not shrink them down to something neat and remove as much noise as possible from your myriad views in JSX? I plan to add a generalised form of <code class="language-plaintext highlighter-rouge">TextInput</code>, <code class="language-plaintext highlighter-rouge">CheckBox</code> and so on to <code class="language-plaintext highlighter-rouge">immuto-react</code>.</p> <h2 id="all-about-properties">All About Properties</h2> <p>So what is <code class="language-plaintext highlighter-rouge">property</code> and how does it work? If you look at how <code class="language-plaintext highlighter-rouge">Book.title</code> is used in <code class="language-plaintext highlighter-rouge">BookEditor</code>, you’ll see that we call it (so it’s a function), passing it a <code class="language-plaintext highlighter-rouge">Book</code> cursor, and we must get back a <code class="language-plaintext highlighter-rouge">Property&lt;string&gt;</code> because we pass that sucker directly into <code class="language-plaintext highlighter-rouge">TextInput</code>’s <code class="language-plaintext highlighter-rouge">property</code> prop.</p> <p>If you made it through the last episode, you’ll have seen the most general way of declaring an action:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">setTitle</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span><span class="dl">"</span><span class="s2">SET_TITLE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">,</span> <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nf">amend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span> <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div> <p>It defines a Redux action creator: a function <code class="language-plaintext highlighter-rouge">setTitle</code> that can be called with a string argument <code class="language-plaintext highlighter-rouge">"Something"</code> and returns a strongly typed action: <code class="language-plaintext highlighter-rouge">{ type: "SET_TITLE", payload: "Something" }</code>.</p> <p>Actions are the only way anything changes in Redux, period. They should be as high-level as possible, and descriptive of the change being made. If we have data that has some invariant that must apply to it, for example:</p> <ul> <li>if string <code class="language-plaintext highlighter-rouge">permission</code> is empty then number <code class="language-plaintext highlighter-rouge">quota</code> must be greater than 0.</li> </ul> <p>then we shouldn’t expose a way to independently set those values. We should instead expose high-level actions that change both values together, in ways that preserve the invariant, so that it is simply not possible to break it.</p> <p>But this typically still leaves a lot of situations where we have a primitive value, such as a string, that is independently chosen by the user. It’s the “bread and butter” of a lot of data models: bunches of named properties that can be independently modified.</p> <p><a href="../../2014/A-new-kind-of-managed-lvalue-pointer">As I’ve noted before in another context</a>, a “property”, an addressable value that can be read and written, is a powerful idea that should be <a href="https://en.wikipedia.org/wiki/Reification" rel="external nofollow noopener" target="_blank">reified</a>, turned into an object that can be stored in a variable, passed as a parameter, etc. The <code class="language-plaintext highlighter-rouge">Property</code> interface is that concept in Immuto.</p> <p>An Immuto cursor implements a variant that idea in which we express “writing” by accepting an action to perform on the value. But for some simple values there is only one action: to set it to a new value carried in the payload. In such cases, requiring you to create and pass that action explicitly is pure ceremony with no purpose.</p> <p>So in these simple and ubiquitous cases, where it makes sense, instead of <code class="language-plaintext highlighter-rouge">action</code> we can use <code class="language-plaintext highlighter-rouge">property</code>:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">TITLE</span><span class="dl">"</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span>
    <span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="nx">title</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">amend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span> <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div> <p>This assigns to <code class="language-plaintext highlighter-rouge">title</code> an object that is both:</p> <ul> <li>an action definition, so it can be added to <code class="language-plaintext highlighter-rouge">Book</code>’s reducer, and</li> <li>a function to which we can pass a <code class="language-plaintext highlighter-rouge">Book</code> cursor, and get back a property instance that is bound to the title of the book we passed.</li> </ul> <p>So when we call that function passing a new title <code class="language-plaintext highlighter-rouge">"1984"</code> for the book, it builds an action <code class="language-plaintext highlighter-rouge">{ type: "TITLE", payload: "1984" }</code> and dispatches it to the <code class="language-plaintext highlighter-rouge">Book</code> cursor, which will take it from there, producing an action path and ultimately dispatching it to the big store in the sky.</p> <p>(Note that I’ve used the name <code class="language-plaintext highlighter-rouge">TITLE</code> rather than <code class="language-plaintext highlighter-rouge">SET_TITLE</code>; of course, action names are entirely up to you. I think if there is nothing else you can do to something apart from <code class="language-plaintext highlighter-rouge">SET</code> it, then there’s no need to qualify it.)</p> <p>In the call to <code class="language-plaintext highlighter-rouge">property</code>, the second argument is the same reducer definition we originally passed to <code class="language-plaintext highlighter-rouge">action</code> in the earlier <code class="language-plaintext highlighter-rouge">setTitle</code> example. The first argument is the new part: a “getter” for the same property.</p> <p>But what a shame to have to effectively say the same thing twice. In a simple example like this, we just want to specify a property name. <a href="https://github.com/Microsoft/TypeScript/issues/10826" rel="external nofollow noopener" target="_blank">In a future version of TypeScript</a> (see <code class="language-plaintext highlighter-rouge">keysof</code> operator) we may be able to do something super-succinct. But for now it seems we’re stuck with ugly repetition. Ugly, ugly repetition. Or are we? Or <em>are</em> we?</p> <p>There is one <a href="http://perfectionkills.com/those-tricky-functions/" rel="external nofollow noopener" target="_blank">clever trick</a> we can play, so we only have to pass the getter:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">title</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span><span class="dl">"</span><span class="s2">TITLE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">title</span><span class="p">);</span>
</code></pre></div></div> <p>If called in this way, the source of the getter function is parsed, and if it matches a simple enough pattern, then the corresponding reducer can be automatically generated! If the getter is too complex then this parsing fails at runtime, which sounds bad. But it’s not too bad, because it’s going to fail at load time, and fail noisily (throwing an <code class="language-plaintext highlighter-rouge">Error</code>). This is the kind of runtime error that is only a gnat’s whisker away from static checking. But this feature does involve sniffing something that is not yet completely standard across browsers, so it’s somewhat experimental. Please help me fix my Regex.</p> <p>So, properties give us a binding capability for simple independent values, and that enables two-way binding layered over type-checked pure Redux actions. Happy Birthday!</p> <h2 id="rendering-a-collection-of-books">Rendering a collection of books</h2> <p>Let’s now move out to the next layer, a shelf containing multiple books:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">Shop</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="nx">name</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="nx">shelves</span><span class="p">:</span> <span class="p">{</span> <span class="p">[</span><span class="nx">name</span><span class="p">:</span> <span class="kr">number</span><span class="p">]:</span> <span class="nx">Shelf</span> <span class="p">};</span>
<span class="p">}</span>

<span class="k">export</span> <span class="k">namespace</span> <span class="nx">Shop</span> <span class="p">{</span>
    <span class="k">export</span> <span class="kd">const</span> <span class="nx">name</span> <span class="o">=</span> <span class="nf">property</span><span class="p">(</span><span class="dl">"</span><span class="s2">NAME</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">shop</span><span class="p">:</span> <span class="nx">Shop</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">shop</span><span class="p">.</span><span class="nx">name</span><span class="p">);</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">shelves</span> <span class="o">=</span> <span class="nf">collection</span><span class="p">(</span>
        <span class="dl">"</span><span class="s2">SHELVES</span><span class="dl">"</span><span class="p">,</span>
        <span class="nx">Shelf</span><span class="p">.</span><span class="nx">reduce</span><span class="p">,</span>
        <span class="nx">numberMapOperations</span><span class="o">&lt;</span><span class="nx">Shelf</span><span class="o">&gt;</span><span class="p">(),</span>
        <span class="p">(</span><span class="nx">shop</span><span class="p">:</span> <span class="nx">Shop</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">shop</span><span class="p">.</span><span class="nx">shelves</span>
    <span class="p">);</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">empty</span><span class="p">:</span> <span class="nx">Shop</span> <span class="o">=</span> <span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span> <span class="na">shelves</span><span class="p">:</span> <span class="p">{}</span> <span class="p">};</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nf">reducer</span><span class="p">(</span><span class="nx">empty</span><span class="p">).</span><span class="nf">action</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nf">action</span><span class="p">(</span><span class="nx">shelves</span><span class="p">);</span>

    <span class="k">export</span> <span class="kd">type</span> <span class="nx">Cursor</span> <span class="o">=</span> <span class="k">typeof</span> <span class="nx">reduce</span><span class="p">.</span><span class="nx">cursorType</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>The extra interesting part here is the collection of books. As we’ve just implemented a component that can render a <code class="language-plaintext highlighter-rouge">Book</code>, let’s use it to render all the books in our collection:</p> <div class="language-tsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">ShelfEditor</span> <span class="o">=</span> <span class="p">({</span> <span class="nx">shelf</span> <span class="p">}:</span> <span class="p">{</span> <span class="nl">shelf</span><span class="p">:</span> <span class="nx">Shelf</span><span class="p">.</span><span class="nx">Cursor</span> <span class="p">})</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="si">{</span><span class="nf">getIds</span><span class="p">(</span><span class="nx">shelf</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">books</span><span class="p">).</span><span class="nf">map</span><span class="p">((</span><span class="nx">book</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">(</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">key</span><span class="p">=</span><span class="si">{</span><span class="nx">book</span><span class="si">}</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nc">BookEditor</span> <span class="na">book</span><span class="p">=</span><span class="si">{</span><span class="nx">Shelf</span><span class="p">.</span><span class="nf">books</span><span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="nx">book</span><span class="p">)</span><span class="si">}</span> <span class="p">/&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">))</span><span class="si">}</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">);</span>
</code></pre></div></div> <p>In fact there’s nothing here I haven’t <a href="Immuto">previously discussed</a>. <code class="language-plaintext highlighter-rouge">Shelf.books</code> is the collection definition, and it’s a way to get a <code class="language-plaintext highlighter-rouge">Book</code> cursor if you have a <code class="language-plaintext highlighter-rouge">Shelf</code> cursor and the key of the book you’re interested in.</p> <p>So these are the basics of how you build components that bind to Immuto models. Note that you are of course free to have other props besides a cursor on a component, and you could even pass multiple cursors in different props.</p> <h2 id="binding-to-the-store">Binding to the store</h2> <p>The final mystery is how to start the whole thing off at the root. We need a way to tie our tree of components to the store. In this example the root of our model is a <code class="language-plaintext highlighter-rouge">Shop</code>. And at last we’re going to use something from <code class="language-plaintext highlighter-rouge">immuto-react</code>!</p> <p>Assuming we have a <code class="language-plaintext highlighter-rouge">ShopEditor</code> along the expected lines, requiring a prop of type <code class="language-plaintext highlighter-rouge">Cursor&lt;Shop&gt;</code>, what we need is an <code class="language-plaintext highlighter-rouge">App</code> component that requires no props and can be rendered as-is.</p> <div class="language-tsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">Shop</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nf">store</span><span class="p">();</span>

<span class="kd">const</span> <span class="nx">App</span> <span class="o">=</span> <span class="nf">bindToStore</span><span class="p">(</span><span class="nx">store</span><span class="p">,</span> <span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">&lt;</span><span class="nc">ShopEditor</span> <span class="na">shop</span><span class="p">=</span><span class="si">{</span><span class="nx">s</span><span class="si">}</span> <span class="p">/&gt;);</span>

<span class="nx">ReactDOM</span><span class="p">.</span><span class="nf">render</span><span class="p">(&lt;</span><span class="nc">App</span> <span class="p">/&gt;,</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#root</span><span class="dl">"</span><span class="p">)</span><span class="o">!</span><span class="p">);</span>
</code></pre></div></div> <p>Here, <code class="language-plaintext highlighter-rouge">bindToStore</code> is a function imported from <code class="language-plaintext highlighter-rouge">immuto-react</code>. You pass it a store to bind to, and also a function which will be called back with a cursor of the same type as the store, which you can then pass into your unbound component.</p> <p>And that’s all there is to it, on a logical level. All data is passed down in pure props. Everything in the entire app is immutable except for one variable, hidden inside the implementation of the Redux store. Components are stateless functions.</p> <h2 id="optimization-by-minimal-rendering">Optimization by minimal rendering</h2> <p>There is one other matter that might be of concern in large apps. If we proceed as described here, we’ll end up re-rendering the entire page every time anything changes, because that’s the default behaviour in React; whenever props are passed in to a component, even the same ones, the component’s is re-rendered. React has to do this because it doesn’t mandate that props are immutable.</p> <p>To avoid this, <code class="language-plaintext highlighter-rouge">immuto-react</code> has another function called <code class="language-plaintext highlighter-rouge">optimize</code>. This wraps a stateless component and returns a new component which is more reluctant to render itself. The rules it uses are quite straightforward.</p> <p>Each time it has the opportunity to re-render, it compares the values of its props to see if they’ve changed. To ensure this happens properly, it compares them with <code class="language-plaintext highlighter-rouge">==</code>, not with <code class="language-plaintext highlighter-rouge">===</code>. This causes the JS engine to call the <code class="language-plaintext highlighter-rouge">valueOf</code> method on each prop; it’s a built-in feature of JavaScript. All objects have a <code class="language-plaintext highlighter-rouge">valueOf</code> method, although most just inherit the default which returns <code class="language-plaintext highlighter-rouge">this</code>. But it can be overridden to return the value that an object represents.</p> <p>And guess what? Immuto’s cursors and properties override <code class="language-plaintext highlighter-rouge">valueOf</code> to return their <code class="language-plaintext highlighter-rouge">state</code>. This means that if you use <code class="language-plaintext highlighter-rouge">optimize</code>, where you have props that are cursors, they will correctly only cause a re-render if the value they refer to has changed, not just because a new cursor has been generated that wraps the same value.</p> <p>Sadly we’re not quite done. A very common pattern in <code class="language-plaintext highlighter-rouge">React</code> is to pass functions as props, to be used as callbacks typically when the user clicks something. These will likely be lambdas that get allocated every time, and yet in many uses they have no effect on rendering. They will completely ruin your attempts to optimize. So to handle this, <code class="language-plaintext highlighter-rouge">optimize</code> also has to allow you to pass an array of string names for the props you want it to ignore. This is the one concession to dynamic typing so far! If you add/remove properties, you will not get any compiler errors if you forget to update your <code class="language-plaintext highlighter-rouge">ignore</code> array. On the other hand, if you do specify a name that is not actually from your props interface, this will not cause a repaint bug. But if you misspell a prop that should be ignored then you’ll get unnecessary repaints.</p> <p>That <code class="language-plaintext highlighter-rouge">keysof</code> operator we may see <a href="https://github.com/Microsoft/TypeScript/issues/10826" rel="external nofollow noopener" target="_blank">in a future version of TypeScript</a> would work well here; if that is added, we’ll be able to ensure that everything on the <code class="language-plaintext highlighter-rouge">ignore</code> array is a true prop name.</p> <h2 id="next-steps">Next steps</h2> <p>One topic I’d like to cover is polymorphic components. For example, suppose a shelf could contain a mixture of items (books, food), but all having a price. In mutable OO there would be a <code class="language-plaintext highlighter-rouge">Product</code> base class with a <code class="language-plaintext highlighter-rouge">price</code> property and the other two would derive from it. But here we have UI in stateless React, we have immutable data which needs to be easily persisted, and we have reducers taking actions. This seems like an interesting thing to figure out a nice solution to.</p> <p>I’ve had a request already to look into how async should work (given that I’ve pooh-poohed Redux middleware), and that’s definitely worth getting into.</p> <p>It would probably be good to do a full comparison with regular Redux, re-implementing the Redux tutorial.</p> <p>Feel free to <a href="https://github.com/danielearwicker/immuto/issues" rel="external nofollow noopener" target="_blank">suggest more</a>.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Java-Csharp/">Language Smackdown: Java vs. C#</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>