<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Immuto - Strongly Typed Redux Composition | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2016/Immuto/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Immuto - Strongly Typed Redux Composition</h1> <p class="post-meta"> Created on September 11, 2016 </p> <p class="post-tags"> <a href="/blog/2016"> <i class="fa-solid fa-calendar fa-sm"></i> 2016 </a>   ·   <a href="/blog/tag/typescript"> <i class="fa-solid fa-hashtag fa-sm"></i> typescript</a>   <a href="/blog/tag/immuto"> <i class="fa-solid fa-hashtag fa-sm"></i> immuto</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><a href="../Good-Redux">What’s good about Redux</a>, I once asked, and I answered with a few things. Like React, it is one of those rare outbreaks of sanity that happen now and then. <a href="http://redux.js.org/docs/basics/Actions.html" rel="external nofollow noopener" target="_blank">Read the docs, they’re easy</a>.</p> <p>There’s very little to the library (which is a good thing), because the main thing it implements is the store, which in its basic form is a very simple idea. I noted before how it says very little about composition patterns. I want ways of plugging reducers together, but with complete static type safety, so that it is not possible to dispatch the wrong kind of action, or an action whose data is not of the right type.</p> <p>One composition feature is <code class="language-plaintext highlighter-rouge">combineReducers</code>, which from a static typing perspective leaves us nowhere to go. Sometimes this happens because TypeScript is lacking some capability, but sometimes it’s just because the library has done something undesirable and I think that’s the case here, for reasons I will now go into at great length.</p> <h3 id="reducers">Reducers</h3> <p>A reducer is a function of the form <code class="language-plaintext highlighter-rouge">(state, action) =&gt; state</code>. It makes a new state from an old one by interpreting an action, which is an instruction on how the state should be altered.</p> <p>For simple examples it’s no bother writing the reducer function by hand. Actions are discriminated by their <code class="language-plaintext highlighter-rouge">type: string</code> property, which must be unique across all actions that can be handled by a given reducer. So in the tutorial we see the expected switch statement. And TypeScript 2.0 handles this very nicely; if you declare all your actions as interfaces, they become <a href="https://github.com/Microsoft/TypeScript/wiki/What's-new-in-TypeScript#tagged-union-types" rel="external nofollow noopener" target="_blank">tagged union types</a> and <code class="language-plaintext highlighter-rouge">switch</code> becomes an adequate form of pattern matching.</p> <p>But there’s still quite a bit of boilerplate required. I think of reducers as being composed of individual reducers per action type. It should be possible to define an action as the combination of a name string and a function <code class="language-plaintext highlighter-rouge">(state, payload) =&gt; state</code> in which payload is the data carried by the action. It should not be necessary to separately declare the action as an interface, and the act of composing several such action definitions should automatically produce a single reducer <code class="language-plaintext highlighter-rouge">(state, action1 | action2) =&gt; state</code>, because it can take any of the specified action types and dispatch it accordingly.</p> <p>To give us an example to drive the discussion, here’s our first bit of state - completely immutable, of course, partly using <a href="https://facebook.github.io/immutable-js/docs/#/List" rel="external nofollow noopener" target="_blank">List from immutable.js</a>:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Book</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="nx">authors</span><span class="p">:</span> <span class="nx">List</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">empty</span><span class="p">:</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">title</span><span class="p">:</span> <span class="dl">""</span><span class="p">,</span>
    <span class="na">price</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="na">authors</span><span class="p">:</span> <span class="nx">List</span><span class="o">&lt;</span><span class="kr">string</span><span class="o">&gt;</span><span class="p">(),</span>
<span class="p">};</span>
</code></pre></div></div> <h2 id="declaring-actions">Declaring actions</h2> <p>If you follow the Redux tutorial you’ll see action creators being declared. These are functions, one per action type, each responsible for creating an instance of an action. These are usually gathered together in a file. Then in another file the reducer function is handwritten, typically as a switch statement, to handle each action type.</p> <p>But really the action type and its interpretation go together. Suppose we could declare them like this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">setTitle</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span><span class="dl">"</span><span class="s2">SET_TITLE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">,</span> <span class="nx">title</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nf">amend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="p">{</span> <span class="nx">title</span> <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">amend</code> function is a slightly honed version of <code class="language-plaintext highlighter-rouge">Object.assign</code>, to stand in for the cool <code class="language-plaintext highlighter-rouge">{ ...book, title }</code> syntax we’re all looking forward to. A couple more actions:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">setPrice</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span><span class="dl">"</span><span class="s2">SET_PRICE</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">,</span> <span class="nx">price</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nf">amend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="p">{</span> <span class="nx">price</span> <span class="p">})</span>
<span class="p">);</span>

<span class="k">export</span> <span class="kd">const</span> <span class="nx">addAuthor</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span><span class="dl">"</span><span class="s2">ADD_AUTHOR</span><span class="dl">"</span><span class="p">,</span> <span class="p">(</span><span class="nx">book</span><span class="p">:</span> <span class="nx">Book</span><span class="p">,</span> <span class="nx">author</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span>
    <span class="nf">amend</span><span class="p">(</span><span class="nx">book</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">authors</span><span class="p">:</span> <span class="nx">book</span><span class="p">.</span><span class="nx">authors</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">author</span><span class="p">),</span>
    <span class="p">})</span>
<span class="p">);</span>
</code></pre></div></div> <p>Having declared these pieces, defining the reducer ought to be as simple as:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nf">reducer</span><span class="p">(</span><span class="nx">empty</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setTitle</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setPrice</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">addAuthor</span><span class="p">);</span>
</code></pre></div></div> <p>Here, <code class="language-plaintext highlighter-rouge">reducer</code> is some helper that takes a “blank object” (serving as our preferred starting state for this type), and has an <code class="language-plaintext highlighter-rouge">action</code> method that we can use to make an actual reducer function, capable of handling a single action. That reducer is already a function, but it also has its own <code class="language-plaintext highlighter-rouge">action</code> method (functions can have methods, of course), allowing us to compose with another action, and so on. The end result is stored in <code class="language-plaintext highlighter-rouge">reduce</code> and is the whole reducer function, <em>strongly typed so it will only accept those three actions</em>.</p> <p>In TypeScript we can reuse a typename as a variable name, as they cannot clash. Indeed <a href="../TypeScript-Class">this is exactly how classes work</a>. So I will gather all the above pieces in a namespace called <code class="language-plaintext highlighter-rouge">Book</code>, to go with the type <code class="language-plaintext highlighter-rouge">Book</code>. In abbreviated form:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Book</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="nx">Book</span> <span class="p">{</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">empty</span><span class="p">:</span> <span class="nx">Book</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">setTitle</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span> <span class="p">...</span> <span class="p">);</span>
    <span class="k">export</span> <span class="kd">const</span> <span class="nx">setPrice</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span> <span class="p">...</span> <span class="p">);</span>
    <span class="k">export</span> <span class="kd">const</span> <span class="nx">addAuthor</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span> <span class="p">...</span> <span class="p">);</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nf">reducer</span><span class="p">(</span><span class="nx">empty</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setTitle</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setPrice</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">addAuthor</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>So I can now do things to books like this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">book1984</span> <span class="o">=</span> <span class="nx">Book</span><span class="p">.</span><span class="nf">reduce</span><span class="p">(</span><span class="nx">Book</span><span class="p">.</span><span class="nx">empty</span><span class="p">,</span> <span class="nx">Book</span><span class="p">.</span><span class="nf">setTitle</span><span class="p">(</span><span class="dl">"</span><span class="s2">1984</span><span class="dl">"</span><span class="p">));</span>
</code></pre></div></div> <p>That is, <code class="language-plaintext highlighter-rouge">Book.setTitle</code> is an action creator in the usual sense, as well as having been woven into <code class="language-plaintext highlighter-rouge">Book.reduce</code>. The latter is made possible by it having a couple of properties, <code class="language-plaintext highlighter-rouge">type</code> of type <code class="language-plaintext highlighter-rouge">"SET_TITLE"</code> and <code class="language-plaintext highlighter-rouge">reduce</code> containing the function <code class="language-plaintext highlighter-rouge">(Book, string) =&gt; Book</code>.</p> <p>We’re adopting the “payload” pattern, where an action only has <code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">payload</code> properties, so:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kr">interface</span> <span class="nx">Action</span><span class="o">&lt;</span><span class="nx">T</span> <span class="kd">extends</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">P</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="na">type</span><span class="p">:</span> <span class="nx">T</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="na">payload</span><span class="p">:</span> <span class="nx">P</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>The type of <code class="language-plaintext highlighter-rouge">Book.reduce</code> is <code class="language-plaintext highlighter-rouge">(state: Book, action: A) =&gt; Book</code>, where <code class="language-plaintext highlighter-rouge">A</code> must come out as the union of three action types:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Action</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">SET_TITLE</span><span class="dl">"</span><span class="p">,</span> <span class="kr">string</span><span class="o">&gt;</span> <span class="o">|</span>
    <span class="nx">Action</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">SET_PRICE</span><span class="dl">"</span><span class="p">,</span> <span class="kr">number</span><span class="o">&gt;</span> <span class="o">|</span>
    <span class="nx">Action</span><span class="o">&lt;</span><span class="dl">"</span><span class="s2">ADD_AUTHOR</span><span class="dl">"</span><span class="p">,</span> <span class="kr">string</span><span class="o">&gt;</span><span class="p">;</span>
</code></pre></div></div> <p>As well as the <code class="language-plaintext highlighter-rouge">action</code> method that allows us to specify what actions the reducer can handle, a reducer might have further methods and properties. It could have a <code class="language-plaintext highlighter-rouge">store</code> method, which wraps the standard Redux <code class="language-plaintext highlighter-rouge">createStore</code> method purely so as to give it a stronger type definition:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bookStore</span> <span class="o">=</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nf">store</span><span class="p">();</span>

<span class="nx">bookStore</span><span class="p">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="nx">Book</span><span class="p">.</span><span class="nf">setPrice</span><span class="p">(</span><span class="mf">3.99</span><span class="p">));</span>

<span class="c1">// Type error: bookStore can't accept Car actions</span>
<span class="nx">bookStore</span><span class="p">.</span><span class="nf">dispatch</span><span class="p">(</span><span class="nx">Car</span><span class="p">.</span><span class="nf">changeGear</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div> <p>The standard Redux <code class="language-plaintext highlighter-rouge">Store</code> interface for dispatching actions is pretty loose, effectively:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">S</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nx">dispatch</span><span class="o">&lt;</span><span class="nx">A</span> <span class="kd">extends</span> <span class="nx">Action</span><span class="o">&gt;</span><span class="p">(</span><span class="na">action</span><span class="p">:</span> <span class="nx">A</span><span class="p">):</span> <span class="nx">A</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>So a store will accept <em>any</em> action, regardless of what the reducer can actually handle. Reducers are supposed to silently ignore actions they don’t understand. I think of this as “action soup”, by analogy with “tag soup” where browsers will take anything that looks vaguely like HTML and silently do their best. Where I’m building an app that I’m in control of, I want something a lot more locked down:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Store</span><span class="o">&lt;</span><span class="nx">S</span><span class="p">,</span> <span class="nx">A</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="nx">dispatch</span><span class="o">&lt;</span><span class="nx">A1</span> <span class="kd">extends</span> <span class="nx">A</span><span class="o">&gt;</span><span class="p">(</span><span class="na">action</span><span class="p">:</span> <span class="nx">A1</span><span class="p">):</span> <span class="nx">A1</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div> <p>That is, <code class="language-plaintext highlighter-rouge">A</code> is the union type of all the supported actions, so <code class="language-plaintext highlighter-rouge">A1</code> is whichever one we pass and hence what will be returned. By the way, the purpose of the return value of <code class="language-plaintext highlighter-rouge">dispatch</code>, and even its type, is not actually completely specified - <a href="https://github.com/reactjs/redux/issues/61" rel="external nofollow noopener" target="_blank">some discussion here</a>. Redux middleware is treacherous territory. Here I’m just documenting the built-in behaviour.</p> <p>Another handy member in our reducers is <code class="language-plaintext highlighter-rouge">actionType: A</code>, which is a property that has the type of the union of all the support actions. Why is this useful? Because we’ve never actually declared that type manually ourselves; it was built for us. We might want to use it to declare parameters or variables. Note that the value of this property is completely worthless (<code class="language-plaintext highlighter-rouge">undefined</code>) It only makes sense to use it after <code class="language-plaintext highlighter-rouge">typeof</code>, the compile-time operator, in a type position, e.g.</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">a</span><span class="p">:</span> <span class="k">typeof</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nx">actionType</span><span class="p">;</span>
</code></pre></div></div> <p>A while ago I <a href="https://github.com/Microsoft/TypeScript/issues/9889" rel="external nofollow noopener" target="_blank">logged an issue</a> requesting the ability to put <code class="language-plaintext highlighter-rouge">type</code> declarations in interfaces, for this very purpose. If we could include a nested type <code class="language-plaintext highlighter-rouge">Action</code> in the interface of a reducer, the above would become:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">a</span><span class="p">:</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nx">Action</span><span class="p">;</span>
</code></pre></div></div> <h2 id="composition-through-nested-actions">Composition through nested actions</h2> <p>A complex immutable data structure is built up by nesting to whatever depth we require. Indeed, if we were modelling a person’s ancestry or the folder structure of a file system then the depth would be determined at runtime. There need not be any app-wide pattern for how to navigate the tree - each node is its own little domain that subdivides itself between further child nodes however it likes.</p> <p>A given node of our structure may interpret an action itself, or it may need to delegate it to a child node. Therefore the child node should have its own reducer. By analogy with OO, the parent object’s class has a method whose implementation calls onto a method in some other class of which the parent owns an instance.</p> <p>In our example, a shelf contains many books. How do we send actions to a book with a shelf? We send an action to the shelf such that it figures out which book to send it on to. This is possible because the payload of an action <em>can contain another action</em>.</p> <p>Here I’m going to send the shelf an action of type <code class="language-plaintext highlighter-rouge">BOOKS</code>, which the shelf knows it must delegate to one of its collection of books:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    type: "BOOKS",
    payload: {
        key: 3,
        update: {
            type: "SET_PRICE",
            3.99
        }
    }
}
</code></pre></div></div> <p>The outer action’s payload has a <code class="language-plaintext highlighter-rouge">key</code>, which identifies which book in the collection to delegate to, and an <code class="language-plaintext highlighter-rouge">update</code> action, which must be an action supported by our <code class="language-plaintext highlighter-rouge">Book</code> reducer (as indeed <code class="language-plaintext highlighter-rouge">"SET_PRICE"</code> is - see above!). The <code class="language-plaintext highlighter-rouge">Shelf</code> reducer asks the <code class="language-plaintext highlighter-rouge">Book</code> reducer to create a modified book with the price change applied to it, and then in turn it creates a new shelf with the new version of book 3 in its collection, so the change ripples up the tree producing a whole new version (but naturally sharing all the unchanged nodes from the previous version).</p> <p>So we can see how actions may be nested in a way that exactly maps to the nested structure to which they will apply. It’s a very natural way to reflect composition of data structures in the composition of operations on those data structures.</p> <p>And if we stick to this approach then we will always be able to exactly describe the types involved. This is very different from the composition approach of Redux’s built-in <code class="language-plaintext highlighter-rouge">combineReducers</code>. By design, that implies a front end interface that works by “action soup”.</p> <p>Let’s call this an <em>action path</em>. It’s purely an action from Redux’s perspective, nothing magic about it. It just happens to follow a well-defined structural pattern.</p> <p>Another nice thing is the polymorphism at work here. The type <code class="language-plaintext highlighter-rouge">typeof Book.reduce.actionType</code> is a base type for all actions that can be applied to a book. So the type of the payload of the <code class="language-plaintext highlighter-rouge">BOOKS</code> action (not that we ever have to manually declare it anywhere) is just:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span>
    <span class="nl">key</span><span class="p">:</span> <span class="kr">number</span><span class="p">;</span>
    <span class="nl">update</span><span class="p">:</span> <span class="k">typeof</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nx">actionType</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">Shelf</code> reducer don’t-give-a-F which particular action we want to perform on the book. It just provides a single, reusable conduit for such actions. We can declare further actions in <code class="language-plaintext highlighter-rouge">Book</code> and never need to update the code for <code class="language-plaintext highlighter-rouge">Shelf</code> at all.</p> <h2 id="cursors-the-redux-way">Cursors, the Redux way</h2> <p><a href="../Good-Redux">As I noted before</a> cursors in the strict sense have been banned from Redux. But it’s important to understand what they are and exactly what is non-Redux-y about them. That way, we can invent the Redux-compliant version by absolutely sticking to the rules of Redux and merely implementing a sufficiently cursor-like pattern to get the best of both worlds.</p> <p>A cursor is a way of referring to a node nested deep within some immutable data structure, so that when you eventually decide how you want to modify that node, the business of “rippling up the tree” is automatically taken care of. You pass the cursor a new version of the object to go at that location, and the whole application’s state tree transitions to a new state, and buried within it, at the corresponding location, is your new version of the node you actually wanted to alter. It’s the immutable equivalent of an OO reference: you can pass it around and anyone who has it can both read and (effectively) “write” to that location, without needing to have intimate knowledge of the wider data structure it is embedded in.</p> <p>So we definitely need something like that. But Redux says that updates must happen by dispatching an action to the store. Okay, so what if instead of a cursor taking a new version of a node it took an action to be dispatched to that node? The cursor is responsible for stitching that action inside another action, and that action inside yet another action, and so on until we have a composed action compatible with our whole store that makes the required update. Funny how we were only just talking about these action paths!</p> <p>So, the Redux-approach version of a cursor can be thought of as a helpful way of composing action paths. If we have some completely independently-developed code module within a larger app, it can be given a cursor that allows it to obtain its current state, and also eventually update it by sending itself an action. It doesn’t need to know what path that action will be wrapped in, and it doesn’t need to know what data structure it lives inside. It might look like this:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Cursor</span><span class="o">&lt;</span><span class="nx">S</span><span class="p">,</span> <span class="nx">A</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="cm">/**
     * The value of the store at the time this cursor was created.
     */</span>
    <span class="k">readonly</span> <span class="na">state</span><span class="p">:</span> <span class="nx">S</span><span class="p">;</span>

    <span class="cm">/**
     * Sends an action into the store's reducer, resulting in the
     * store updating, and a new cursor is returned representing
     * the new state.
     */</span>
    <span class="p">(</span><span class="na">action</span><span class="p">:</span> <span class="nx">A</span><span class="p">):</span> <span class="nx">Cursor</span><span class="o">&lt;</span><span class="nx">S</span><span class="p">,</span> <span class="nx">A</span><span class="o">&gt;</span><span class="p">;</span>

    <span class="cm">/**
     * A cursor may address an object that no longer exists or
     * hasn't yet been created, in which case the state will be
     * the empty object for the type. The exists property can be
     * used to unambiguously detect whether the object really
     * exists.
     */</span>
    <span class="k">readonly</span> <span class="na">exists</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>It’s a bit like a mini-store, and we could presumably have made the interface to a cursor a true subset of the <code class="language-plaintext highlighter-rouge">Store</code> interface, which has <code class="language-plaintext highlighter-rouge">getState</code> and <code class="language-plaintext highlighter-rouge">dispatch</code>. But I want to make a clear distinction: Redux’s <code class="language-plaintext highlighter-rouge">Store#getState</code> is not a pure function, because it returns whatever the state is (or was) at the instant you called it; its value changes over time. This is a necessity because the store’s very purpose is to be the one mutable object in the app, and to be a sub-hub that raises a notification whenever it mutates. Like a dumpster/skip/trash-can/rubbish-bin, it has to be messy in order to serve its purpose of containing the mess. But that doesn’t mean we need to let that impurity leak out into the rest of the app! Let us, with <a href="http://www.oxforddictionaries.com/definition/english/put-one's-finger-in-the-dyke" rel="external nofollow noopener" target="_blank">one finger firmly in the dyke</a>, hold to the principle that a cursor is immutable. So rather than a <code class="language-plaintext highlighter-rouge">getState</code> method, it has a simple, <code class="language-plaintext highlighter-rouge">readonly state</code> property, which never changes for the lifetime of the cursor.</p> <p>Also, as it has one clear primary function, a cursor <em>is</em> a function - rather than it being an object with a <code class="language-plaintext highlighter-rouge">dispatch</code> method, you simply call it as a function passing it an action. It cuts a lot of noise out of code. Though I still tend to think of this as “dispatching” to the cursor.</p> <p>When you dispatch an action to the cursor, it returns a new <code class="language-plaintext highlighter-rouge">Cursor</code> (another difference from <code class="language-plaintext highlighter-rouge">Store#dispatch</code>), which gives you access to the updated state addressed by that cursor, should you need it. In a React app, you’ll probably get re-rendered so might never use this capability. If you use Redux middleware, and it changes the fundamental nature of how the store works, you might get the same cursor back because although the built-in Redux store is strictly synchronous (brace yourself), middleware can change this.</p> <h2 id="middleware-considered-harmful">Middleware considered harmful?</h2> <p>There are various ideas for how you might use the <em>middleware</em> feature in Redux. They seem like an unfortunate misstep to me. The beauty of Redux is that its central idea is so simple and general, it doesn’t need to be changed. You can just build stuff on top of it, using it as a solid platform. But if you start changing the platform, you destroy the foundational assumptions that your work is based on. The basic principle that the store update is synchronous, not to mention the simplicity of the types involved, is really important.</p> <p>The problem here is not with the ideas enabled by middleware (e.g. convenient orchestration of asynchronous operations). The problem is the idea that they should be grafted into the store itself, changing its basic nature. Instead, let’s practice separation of concerns, and keep the store as a synchronously updatable container for a single immutable data structure. If we want other facilities that work differently alongside the store, we should implement such facilities separately, and have them dispatch actions to the store from the outside. No magic involved. A store is just a store.</p> <h2 id="collections">Collections</h2> <p>Now let’s think about the challenges involved in implementing cursors on a multi-nested, dynamically growing data structure. As an example we’ll take another step back: we already have <code class="language-plaintext highlighter-rouge">Book</code>, and a <code class="language-plaintext highlighter-rouge">Shelf</code> that has a collection of books. Let’s have a <code class="language-plaintext highlighter-rouge">Shop</code> (UK English terminology to avoid clashing with <code class="language-plaintext highlighter-rouge">Store</code>) that has a collection of shelves. There is obvious similarity between levels, and most apps will involve this kind of pattern. We need to be able to address things inside containers, at multiple levels.</p> <p>Let’s declare the <code class="language-plaintext highlighter-rouge">Shelf</code> datatype:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">Shelf</span> <span class="p">{</span>
    <span class="k">readonly</span> <span class="nx">description</span><span class="p">:</span> <span class="kr">string</span><span class="p">;</span>
    <span class="k">readonly</span> <span class="nx">books</span><span class="p">:</span> <span class="nb">Map</span><span class="o">&lt;</span><span class="kr">number</span><span class="p">,</span> <span class="nx">Book</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>I’m using <a href="https://facebook.github.io/immutable-js/docs/#/Map" rel="external nofollow noopener" target="_blank">Map from immutable.js</a>, and so each book has an ID number of some kind.</p> <p>Suppose we have available to us another helper function, <code class="language-plaintext highlighter-rouge">collection</code>, which defines how a collection of objects should work:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">books</span> <span class="o">=</span> <span class="nf">collection</span><span class="p">({</span>
    <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">BOOKS</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">reducer</span><span class="p">:</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">,</span>
    <span class="na">operations</span><span class="p">:</span> <span class="cm">/* ... TBD... */</span><span class="p">,</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">(</span><span class="na">shelf</span><span class="p">:</span> <span class="nx">Shelf</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">shelf</span><span class="p">.</span><span class="nx">books</span><span class="p">,</span>
    <span class="na">set</span><span class="p">:</span> <span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="nx">books</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">amend</span><span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="p">{</span> <span class="nx">books</span> <span class="p">})</span>
<span class="p">});</span>
</code></pre></div></div> <p>It returns a function <code class="language-plaintext highlighter-rouge">books</code> that can be used to make cursors to books within the collection:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">book123</span> <span class="o">=</span> <span class="nf">books</span><span class="p">(</span><span class="nx">someShelf</span><span class="p">,</span> <span class="mi">123</span><span class="p">);</span>
</code></pre></div></div> <p>The first argument, <code class="language-plaintext highlighter-rouge">someShelf</code>, is itself a cursor to a <code class="language-plaintext highlighter-rouge">Shelf</code> (see how this gets nesty?) The collection definition has to specify (via its <code class="language-plaintext highlighter-rouge">get</code> and <code class="language-plaintext highlighter-rouge">set</code> functions) how to read and update the book collection inside a <code class="language-plaintext highlighter-rouge">Shelf</code>. It also is told what <code class="language-plaintext highlighter-rouge">reducer</code> to use on the collection items when they need to be updated via an action.</p> <p>The <code class="language-plaintext highlighter-rouge">operations</code> object, which I’ve left dangling until now, is separated out so that it can be defined once for some generic collection type (such as <code class="language-plaintext highlighter-rouge">Map&lt;K, I&gt;</code>) and reused forever after. It has to conform to the following interface, and basically just provides the operations we require over a collection type, <code class="language-plaintext highlighter-rouge">C</code>, using key <code class="language-plaintext highlighter-rouge">K</code> and item <code class="language-plaintext highlighter-rouge">I</code>:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kr">interface</span> <span class="nx">CollectionOperations</span><span class="o">&lt;</span><span class="nx">C</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">I</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="na">get</span><span class="p">:</span> <span class="p">(</span><span class="na">state</span><span class="p">:</span> <span class="nx">C</span><span class="p">,</span> <span class="na">key</span><span class="p">:</span> <span class="nx">K</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="na">exists</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">;</span> <span class="nl">value</span><span class="p">?:</span> <span class="nx">I</span> <span class="p">};</span>
    <span class="nl">set</span><span class="p">:</span> <span class="p">(</span><span class="na">state</span><span class="p">:</span> <span class="nx">C</span><span class="p">,</span> <span class="na">key</span><span class="p">:</span> <span class="nx">K</span><span class="p">,</span> <span class="na">item</span><span class="p">:</span> <span class="nx">I</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">;</span>
    <span class="nl">remove</span><span class="p">:</span> <span class="p">(</span><span class="na">state</span><span class="p">:</span> <span class="nx">C</span><span class="p">,</span> <span class="na">key</span><span class="p">:</span> <span class="nx">K</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">C</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <p>It lets us get a value (which might not exist), and also set or remove a value (non-destructively of course). This set of operations can be defined on a wide range of collections, and here’s how it would be implemented for the immutable <code class="language-plaintext highlighter-rouge">Map&lt;K, I&gt;</code>:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nf">immutableMap</span><span class="o">&lt;</span><span class="nx">K</span><span class="p">,</span> <span class="nx">I</span><span class="o">&gt;</span><span class="p">():</span> <span class="nx">CollectionOperations</span><span class="o">&lt;</span><span class="nb">Map</span><span class="o">&lt;</span><span class="nx">K</span><span class="p">,</span> <span class="nx">I</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">K</span><span class="p">,</span> <span class="nx">I</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="nf">get</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">{</span> <span class="na">exists</span><span class="p">:</span> <span class="nx">items</span><span class="p">.</span><span class="nf">has</span><span class="p">(</span><span class="nx">key</span><span class="p">),</span> <span class="na">value</span><span class="p">:</span> <span class="nx">items</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span> <span class="p">};</span>
        <span class="p">},</span>

        <span class="nf">set</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">items</span><span class="p">.</span><span class="nf">set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span> <span class="nx">item</span><span class="p">);</span>
        <span class="p">},</span>

        <span class="nf">remove</span><span class="p">(</span><span class="nx">items</span><span class="p">,</span> <span class="nx">key</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">items</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
        <span class="p">},</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div> <p>We could instead implement it to use a plain JS object as the collection. Anyhow, as well as being a function for making cursors, a collection such as <code class="language-plaintext highlighter-rouge">books</code> also has <code class="language-plaintext highlighter-rouge">type</code> and <code class="language-plaintext highlighter-rouge">reduce</code> properties, as it is also an action definition, which means it can be added to a reducer:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nx">reducer</span><span class="o">&lt;</span><span class="nx">Shelf</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">empty</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setDescription</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">books</span><span class="p">);</span>
</code></pre></div></div> <p>So once again we can wrap all these pieces up in a neat package:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">namespace</span> <span class="nx">Shelf</span> <span class="p">{</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">empty</span><span class="p">:</span> <span class="nx">Shelf</span> <span class="o">=</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">setDescription</span> <span class="o">=</span> <span class="nf">action</span><span class="p">(</span><span class="dl">"</span><span class="s2">SET_DESCRIPTION</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">(</span><span class="nx">shelf</span><span class="p">:</span> <span class="nx">Shelf</span><span class="p">,</span> <span class="nx">description</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">amend</span><span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="p">{</span> <span class="nx">description</span> <span class="p">}));</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">books</span> <span class="o">=</span> <span class="nf">collection</span><span class="p">({</span>
        <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">BOOKS</span><span class="dl">"</span><span class="p">,</span>
        <span class="na">reducer</span><span class="p">:</span> <span class="nx">Book</span><span class="p">.</span><span class="nx">reduce</span><span class="p">,</span>
        <span class="na">operations</span><span class="p">:</span> <span class="nx">immutableMap</span><span class="o">&lt;</span><span class="kr">number</span><span class="p">,</span> <span class="nx">Book</span><span class="o">&gt;</span><span class="p">(),</span>
        <span class="na">get</span><span class="p">:</span> <span class="p">(</span><span class="na">shelf</span><span class="p">:</span> <span class="nx">Shelf</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">shelf</span><span class="p">.</span><span class="nx">books</span><span class="p">,</span>
        <span class="na">set</span><span class="p">:</span> <span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="nx">books</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nf">amend</span><span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="p">{</span> <span class="nx">books</span> <span class="p">})</span>
    <span class="p">});</span>

    <span class="k">export</span> <span class="kd">const</span> <span class="nx">reduce</span> <span class="o">=</span> <span class="nf">reducer</span><span class="p">(</span><span class="nx">empty</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">setDescription</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">action</span><span class="p">(</span><span class="nx">books</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>So now I have a function <code class="language-plaintext highlighter-rouge">Shelf.reduce</code> that is the reducer for a <code class="language-plaintext highlighter-rouge">Shelf</code> object, and also a function <code class="language-plaintext highlighter-rouge">Shelf.books</code> from which I can conveniently make cursors:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">restrictedShelf</span> <span class="o">=</span> <span class="c1">// ... cursor from somewhere</span>

<span class="kd">const</span> <span class="nx">horcruxBook</span> <span class="o">=</span> <span class="nx">Shelf</span><span class="p">.</span><span class="nf">books</span><span class="p">(</span><span class="nx">restrictedShelf</span><span class="p">,</span> <span class="mi">666</span><span class="p">);</span>

<span class="nf">horcruxBook</span><span class="p">(</span><span class="nx">Book</span><span class="p">.</span><span class="nf">addAuthor</span><span class="p">(</span><span class="dl">"</span><span class="s2">Voldemort</span><span class="dl">"</span><span class="p">));</span>
</code></pre></div></div> <p>See how I’m dispatching to the book cursor? I don’t need to dispatch to the shelf, and yet effectively that’s what I’m doing. The book cursor wraps my <code class="language-plaintext highlighter-rouge">"ADD_AUTHOR"</code> action in a <code class="language-plaintext highlighter-rouge">"BOOKS"</code> action and dispatches it to the shelf cursor.</p> <p>To tie this up to a Redux store we need a way to get a cursor from the store. That’s what <code class="language-plaintext highlighter-rouge">snapshot</code> is for:</p> <div class="language-ts highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Make a store containing an empty Shop</span>
<span class="kd">const</span> <span class="nx">store</span> <span class="o">=</span> <span class="nx">Shop</span><span class="p">.</span><span class="nx">reduce</span><span class="p">.</span><span class="nf">store</span><span class="p">();</span>

<span class="c1">// Get a cursor to the shop</span>
<span class="kd">const</span> <span class="nx">shop</span> <span class="o">=</span> <span class="nf">snapshot</span><span class="p">(</span><span class="nx">store</span><span class="p">);</span>

<span class="c1">// Get a shelf within the shop</span>
<span class="kd">const</span> <span class="nx">shelf</span> <span class="o">=</span> <span class="nx">Shop</span><span class="p">.</span><span class="nf">shelves</span><span class="p">(</span><span class="nx">shop</span><span class="p">,</span> <span class="dl">"</span><span class="s2">fiction</span><span class="dl">"</span><span class="p">);</span>

<span class="c1">// Get a book within the shelf</span>
<span class="kd">const</span> <span class="nx">book</span> <span class="o">=</span> <span class="nx">Shelf</span><span class="p">.</span><span class="nf">books</span><span class="p">(</span><span class="nx">shelf</span><span class="p">,</span> <span class="mi">109423</span><span class="p">);</span>

<span class="c1">// Update the book using an action</span>
<span class="nf">book</span><span class="p">(</span><span class="nx">Book</span><span class="p">.</span><span class="nf">setTitle</span><span class="p">(</span><span class="dl">"</span><span class="s2">1985</span><span class="dl">"</span><span class="p">));</span>

<span class="c1">// Check the store has been updated</span>
<span class="nf">expect</span><span class="p">(</span><span class="nx">store</span><span class="p">.</span><span class="nf">getState</span><span class="p">().</span><span class="nx">shelves</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">fiction</span><span class="dl">"</span><span class="p">).</span><span class="nx">books</span><span class="p">.</span><span class="nf">get</span><span class="p">(</span><span class="mi">109423</span><span class="p">).</span><span class="nx">title</span><span class="p">).</span><span class="nf">toEqual</span><span class="p">(</span>
    <span class="dl">"</span><span class="s2">1985</span><span class="dl">"</span>
<span class="p">);</span>
</code></pre></div></div> <p>This demonstrates another nice feature of these lazy cursors; if you ask for object that isn’t in the collection, they act like it is and return you the appropriate empty object. So you can build structures with next to no effort. How do they know what the empty object should be? Well, we’ve told them! When we declare a <code class="language-plaintext highlighter-rouge">collection</code> we give it the reducer for its items, e.g. <code class="language-plaintext highlighter-rouge">Book.reduce</code>, which has an <code class="language-plaintext highlighter-rouge">empty</code> property specifying what an empty <code class="language-plaintext highlighter-rouge">Book</code> should be.</p> <h2 id="want-to-try-it-for-yourself">Want to try it for yourself?</h2> <p>I’ve put these various utilities together in a library called <a href="https://github.com/danielearwicker/immuto" rel="external nofollow noopener" target="_blank">Immuto</a>:</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm <span class="nb">install </span>immuto
</code></pre></div></div> <p>Naturally it has built-in type definitions, no need to install any separately. If you look at the rough tests in <a href="https://github.com/danielearwicker/immuto/blob/master/spec" rel="external nofollow noopener" target="_blank">immuto/spec</a> you’ll see they’re based on the same book/shelf/shop example I used here.</p> <p>Happy type-safe composable Reduxing!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai3/">Poorly Structured Notes on AI Part 3</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>