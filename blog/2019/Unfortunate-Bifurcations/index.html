<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Unfortunate Bifurcations | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2019/Unfortunate-Bifurcations/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Unfortunate Bifurcations</h1> <p class="post-meta"> Created on November 24, 2019 </p> <p class="post-tags"> <a href="/blog/2019"> <i class="fa-solid fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/c"> <i class="fa-solid fa-hashtag fa-sm"></i> C#</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>Although this is going to seem like a series of picky complaints about C#, really it’s about how any language has to evolve, and is a compromise between past and future, and the whole thing is quite difficult.</p> <p>Also some speculation on what the future of language interoperability will be.</p> <p>The kind of problem I’m going to pick on is where languages separate two concepts and treat them differently, making a virtue of the differences, but then it becomes a pain dealing with them generically. The language designers seem to be saying “You shouldn’t need to treat these two things the same; they’re fundamentally different. You’re doing it all wrong!” And yet…</p> <p>Java did this with its separation between:</p> <ul> <li>user-defined (and standard library) types, known as classes, whose objects are <em>referred to</em> by variables known as references, and can be aliased (that is, more than one variable can refer to the same object), and have no built-in way of being copied, and (as a technical detail) are garbage collected. Assignment always means “copy the identity so as to refer to the same object”, and equality means “same object?”</li> <li>primitive built-in types such as <code class="language-plaintext highlighter-rouge">boolean</code> and various numeric ones that are always owned by a single variable or field, and can all be copied. They either live on the stack or inside another object. Assignment means “copy the value” and equality means “same value?”</li> </ul> <p>It seems at first that I can use either as the type of a variable, or a parameter, or a returned value, so they’re there are a lot of places where they are interchangeable, but these ultimately fall apart in various annoying ways. I can define my own types for objects that can be aliased, but not if I want to create an object that can’t be aliased. There is further pain when dealing with generics. Only class types can be used as type parameters. Primitives have to be <em>boxed</em> (stored inside a wrapper object of class type), so every primitive has a corresponding box type. This damages performance enough that most general purpose libraries have to provide <a href="https://docs.oracle.com/javase/8/docs/api/java/util/stream/IntStream.html" rel="external nofollow noopener" target="_blank">primitive-specific specialisations of their classes</a>. The infection even <a href="https://twitter.com/kotlin/status/1195295424963235840" rel="external nofollow noopener" target="_blank">spreads into other languages that target the JVM</a>.</p> <p>The language automatically coerces primitives to their box type where it can, but <a href="https://stackoverflow.com/a/5199418/27423" rel="external nofollow noopener" target="_blank">this can lead to strange problems</a> due to the different meaning of equality for class and primitive types, and some unfortunate details of how auto-boxing works.</p> <p>C# improved on this situation a lot. With its <code class="language-plaintext highlighter-rouge">struct</code> keyword it lets you define your own compound types that work just like primitives, and collectively they are all known as <em>value</em> types. Auto-boxing is a lot more seamless. Also you can define what the <code class="language-plaintext highlighter-rouge">==</code> operation means on your types, which can be used to hide the differences. Finally, it did a much better job with generics, eliminating most needs for boxing and hand-maintained specialisations.</p> <p>Generics provide us with a way to be abstract about certain details. Suppose we want to capture the pattern of retrying operations. A basic example:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">answer</span> <span class="p">=</span> <span class="n">Util</span><span class="p">.</span><span class="nf">Retry</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">GetTheAnswer</span><span class="p">());</span>
</code></pre></div></div> <p>That <code class="language-plaintext highlighter-rouge">Retry</code> method calls the operation passed into it until it succeeds without throwing, and passed back the result. What type is the parameter to <code class="language-plaintext highlighter-rouge">Retry</code>? It needs to return a value, so it’s going to be <code class="language-plaintext highlighter-rouge">Func&lt;T&gt;</code>. C# will infer the <code class="language-plaintext highlighter-rouge">T</code> from my usage, so <code class="language-plaintext highlighter-rouge">answer</code> ends up having the same type as is returned by <code class="language-plaintext highlighter-rouge">GetTheAnswer</code>. Neat.</p> <p>The efficient way to deal with values of primitive types is likely to be different to that for handling reference types, but this detail is hidden from us in C# - the JIT automatically produces one instance of directly executable machine code to be used for all reference types in place of <code class="language-plaintext highlighter-rouge">T</code>, and then one further instance for every value type we use. This expansion <em>isn’t</em> done by the C# compiler, which just has to produce a single generic version of the <a href="https://en.wikipedia.org/wiki/Common_Intermediate_Language" rel="external nofollow noopener" target="_blank">CIL bytecode</a>.</p> <p>How about:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Util</span><span class="p">.</span><span class="nf">Retry</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">CauseTheSideEffect</span><span class="p">());</span>
</code></pre></div></div> <p>Same idea, but now I don’t need a return value, because <code class="language-plaintext highlighter-rouge">CauseTheSideEffect</code> “returns” <code class="language-plaintext highlighter-rouge">void</code>. Is this going to work? <code class="language-plaintext highlighter-rouge">Retry</code> is going to be something like this:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T</span> <span class="n">Retry</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="m">4</span><span class="p">;</span> <span class="n">n</span> <span class="p">&gt;=</span> <span class="m">0</span><span class="p">;</span> <span class="n">n</span><span class="p">--)</span>
    <span class="p">{</span>
        <span class="k">try</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="nf">operation</span><span class="p">();</span>
        <span class="p">}</span>
        <span class="k">catch</span> <span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">when</span> <span class="p">(</span><span class="n">x</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// log x?</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>So we’d like <code class="language-plaintext highlighter-rouge">T</code> to be able to be <code class="language-plaintext highlighter-rouge">void</code>. It doesn’t seem to be asking much, because we’re never doing anything with <code class="language-plaintext highlighter-rouge">T</code> as a value; we just return it. It seems like the language could be lax about this and let a <code class="language-plaintext highlighter-rouge">return</code> statement precede a call to a <code class="language-plaintext highlighter-rouge">void</code> method inside another <code class="language-plaintext highlighter-rouge">void</code> method. <a href="https://www.geeksforgeeks.org/return-void-functions-c/" rel="external nofollow noopener" target="_blank">This is what C++ does.</a>.</p> <p>But C++ can get away with this because it instantiates its version of generics (templates) by pretty much replaying your source code like a macro, so if <code class="language-plaintext highlighter-rouge">void</code> caused trouble somewhere inside the template’s code this would produce an error message, often quite confusingly. C# doesn’t work like that - it produces <em>one</em> version of your code in CIL, and CIL uses a different instruction for calling a <code class="language-plaintext highlighter-rouge">void</code> method. This unfortunate bifurcation runs deep.</p> <p>We can mask the problem by providing an overload like this:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">void</span> <span class="nf">Retry</span><span class="p">(</span><span class="n">Action</span> <span class="n">operation</span><span class="p">)</span>
     <span class="p">=&gt;</span> <span class="nf">Retry</span><span class="p">(()</span> <span class="p">=&gt;</span>
        <span class="p">{</span>
            <span class="nf">operation</span><span class="p">();</span>
            <span class="k">return</span> <span class="m">0</span><span class="p">;</span>
        <span class="p">});</span>
</code></pre></div></div> <p>The return value is arbitrary. And so in theory the C# compiler could allow us to use the underlying <code class="language-plaintext highlighter-rouge">Func&lt;T&gt;</code> version of <code class="language-plaintext highlighter-rouge">Retry</code> by noticing we aren’t returning anything and therefore filling in the <code class="language-plaintext highlighter-rouge">return 0;</code> for us at the point of use. But obviously it shouldn’t always do this, because it would weaken the compiler’s ability to spot bugs, due to it silently passing dummy values into our code.</p> <p>There are other bifurcations that are even more problematic. The worst is probably <code class="language-plaintext highlighter-rouge">async</code>/<code class="language-plaintext highlighter-rouge">await</code>. Extending our example:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">answer</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Util</span><span class="p">.</span><span class="nf">Retry</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="nf">GetTheAnswerAsync</span><span class="p">());</span>
</code></pre></div></div> <p>Now we have to re-write retry to accept a <code class="language-plaintext highlighter-rouge">Func&lt;Task&lt;T&gt;&gt;</code> and use <code class="language-plaintext highlighter-rouge">async</code>/<code class="language-plaintext highlighter-rouge">await</code> internally, and then restore our original synchronous version via a wrapper overload:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">T</span> <span class="nf">Retry</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">operation</span><span class="p">)</span>
     <span class="p">=&gt;</span> <span class="nf">Retry</span><span class="p">(()</span> <span class="p">=&gt;</span> <span class="n">Task</span><span class="p">.</span><span class="nf">FromResult</span><span class="p">(</span><span class="nf">operation</span><span class="p">())).</span><span class="n">Result</span><span class="p">;</span>
</code></pre></div></div> <p>So we have to wrap the result of the inner <code class="language-plaintext highlighter-rouge">operation</code> in a <code class="language-plaintext highlighter-rouge">Task&lt;T&gt;</code> and then extract the <code class="language-plaintext highlighter-rouge">Result</code> on the outside. Thanks to the way <code class="language-plaintext highlighter-rouge">await</code> works this won’t actually involve any hidden asynchrony: the inner <code class="language-plaintext highlighter-rouge">Task&lt;T&gt;</code> is already completed, so <code class="language-plaintext highlighter-rouge">await</code> doesn’t try to yield control, and similarly the <code class="language-plaintext highlighter-rouge">Result</code> property doesn’t need to <code class="language-plaintext highlighter-rouge">Wait</code>.</p> <p>It’s once you have two such bifurcations that things like <code class="language-plaintext highlighter-rouge">Retry</code> become tedious: you need <em>four</em> overloads to cover every case.</p> <p>With the addition of nullable references in C# 8 there is another nasty example, which is actually the old split between reference and value types coming back to bite us. Surprisingly, there is currently no way to express <code class="language-plaintext highlighter-rouge">T?</code> where <code class="language-plaintext highlighter-rouge">T</code> is any type, value or reference. Support for nullable value types has been in the language for a very long time, but they work very differently because for a value type adding support for an additional <code class="language-plaintext highlighter-rouge">null</code> state requires extra storage along side the value itself (and to get at the value requires you to look in the <code class="language-plaintext highlighter-rouge">Value</code> property). Reference types by contrast have always supported the special <code class="language-plaintext highlighter-rouge">null</code> value; what’s being added now is the ability to constrain them so they (mostly) don’t allow <code class="language-plaintext highlighter-rouge">null</code>, which is essentially a compile-time concept. So although the language seems to have a general concept of a nullable “thing”, it really doesn’t. It just uses the same <code class="language-plaintext highlighter-rouge">?</code> suffix syntax to denote the nullable variants of two entirely different things.</p> <p>As a deliberately simple example consider the good old <em>Maybe</em> monadic bind operator, popularly defined as <code class="language-plaintext highlighter-rouge">IsNotNull</code>:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">TResult</span><span class="p">?</span> <span class="n">IsNotNull</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">TArg</span><span class="p">?</span> <span class="n">arg</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TArg</span> <span class="p">:</span> <span class="k">class</span>
        <span class="nc">where</span> <span class="n">TResult</span> <span class="p">:</span> <span class="k">class</span>
            <span class="err">=&gt;</span> <span class="nc">arg</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">operation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>
</code></pre></div></div> <p>Note that I’ve had to constrain both <code class="language-plaintext highlighter-rouge">TArg</code> and <code class="language-plaintext highlighter-rouge">TResult</code> as being reference types (<code class="language-plaintext highlighter-rouge">where</code>… <code class="language-plaintext highlighter-rouge">class</code>). So to cover every possible combination of <code class="language-plaintext highlighter-rouge">struct</code> and <code class="language-plaintext highlighter-rouge">class</code> for the input and result, I need four overloads! But even worse, this time I can’t cheat by making three of them into simple wrappers that call into a single implementation. A nullable reference type is really just a plain reference type in a compile-time disguise, where as a nullable value type is entirely different from its underlying value type at runtime. We have no choice but to copy and paste the code of our method four times, and make slight modifications to each case:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="n">TResult</span><span class="p">?</span> <span class="n">IsNotNull</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">TArg</span><span class="p">?</span> <span class="n">arg</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">?&gt;</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TArg</span> <span class="p">:</span> <span class="k">class</span>
        <span class="nc">where</span> <span class="n">TResult</span> <span class="p">:</span> <span class="k">class</span>
            <span class="err">=&gt;</span> <span class="nc">arg</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">operation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">TResult</span><span class="p">?</span> <span class="n">IsNotNull</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">TArg</span><span class="p">?</span> <span class="n">arg</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">?&gt;</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TArg</span> <span class="p">:</span> <span class="k">struct</span>
        <span class="nc">where</span> <span class="n">TResult</span> <span class="p">:</span> <span class="k">class</span>
            <span class="err">=&gt;</span> <span class="nc">arg</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">operation</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">TResult</span><span class="p">?</span> <span class="n">IsNotNull</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">TArg</span><span class="p">?</span> <span class="n">arg</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">?&gt;</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TArg</span> <span class="p">:</span> <span class="k">class</span>
        <span class="nc">where</span> <span class="n">TResult</span> <span class="p">:</span> <span class="k">struct</span>
            <span class="err">=&gt;</span> <span class="nc">arg</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">operation</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="p">:</span> <span class="k">default</span><span class="p">;</span>

<span class="k">public</span> <span class="k">static</span> <span class="n">TResult</span><span class="p">?</span> <span class="n">IsNotNull</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">&gt;(</span>
    <span class="k">this</span> <span class="n">TArg</span><span class="p">?</span> <span class="n">arg</span><span class="p">,</span>
    <span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg</span><span class="p">,</span> <span class="n">TResult</span><span class="p">?&gt;</span> <span class="n">operation</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TArg</span> <span class="p">:</span> <span class="k">struct</span>
        <span class="nc">where</span> <span class="n">TResult</span> <span class="p">:</span> <span class="k">struct</span>
            <span class="err">=&gt;</span> <span class="nc">arg</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">?</span> <span class="nf">operation</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">Value</span><span class="p">)</span> <span class="p">:</span> <span class="k">default</span><span class="p">;</span>
</code></pre></div></div> <p>When we say <code class="language-plaintext highlighter-rouge">arg != null</code>, in half the cases (where <code class="language-plaintext highlighter-rouge">arg</code> is a value type) that’s just sugar for <code class="language-plaintext highlighter-rouge">arg.HasValue</code>, but such sugar is non-existent when we need to get the value: we have to say <code class="language-plaintext highlighter-rouge">arg.Value</code>. Also when we want to substitute <code class="language-plaintext highlighter-rouge">null</code>, in half the cases (where the result is a value type) we have to use the <code class="language-plaintext highlighter-rouge">default</code> keyword, which is the 7.x abbreviation of <code class="language-plaintext highlighter-rouge">default(TResult?)</code> and means “<code class="language-plaintext highlighter-rouge">Nullable&lt;TResult&gt;</code> with no value”.</p> <p>If this was a less trivial example, it would be a genuine pain to maintain those four version. If you had to add another generic nullable parameter, it would double again the number of hand-maintained not-quite-the-same overloads required.</p> <p>Now combine that with <code class="language-plaintext highlighter-rouge">async</code> versions of everything and you double the overloads again. See how these bifurcations get out hand - before you know it <a href="https://en.wikipedia.org/wiki/Wheat_and_chessboard_problem#Second_half_of_the_chessboard" rel="external nofollow noopener" target="_blank">you’re in the second half of the chessboard.</a> Okay, that’s a slight exaggeration.</p> <p>Anyway, this kind of evolutionary pain is why people start again with new languages. But I think the way forward is already indicated. The CLR is a runtime that is too opinionated and richly featured. This was intended to create a way forward so that a wide range of languages could share libraries with each other. When that happens, it will be utopia compared with today.</p> <p>But the CLR isn’t going to be the platform for that utopia. It was intended to be general enough to support all languages, but now even its flagship showcase language, C#, is showing the strain of supporting its real life users while constrained by the CLR’s underlying model. Yes, it’s better than the JVM, but that’s a very low bar.</p> <p>Meanwhile the last decade has seen runtimes for Javascript become so ingeniously self-optimising that they can compete with native code even for raw number crunching. There are 3D game engines written in JS. There are emulators for mainstream processors written in plain JS that <a href="https://bellard.org/jslinux/" rel="external nofollow noopener" target="_blank">can boot actual operating systems in the browser</a> - nearly a decade ago this was done for a minimal Linux, but Windows 2000 is now there too.</p> <p>WebAssembly in a sense grew out of such efforts, but it has only just started. At the moment it provides a sandbox within which an old-school native C/C++ codebase can freely scribble over its own patch of memory without causing wider damage. It does not yet define how a hosted language may expose fine grained objects that will be automatically garbage collected, and can have named members inside them, some of which may be callable. Hopefully when that step is taken, it will initially be as minimal and vague as possible, instead of (as the CLR did) trying to cover every possible approach with fine-grained features.</p> <p>And then we will have a real breakthrough, because a wide range of languages will be able to move on to the super-fast JS runtimes and bring their libraries with them. We will be able to create data structures that lace together objects written in C#, JavaScript and Python, all to be collected by the same GC.</p> <p>TypeScript has shown that a type system can be organically fitted over a very dynamic object model, and it can grow to meet user needs in ways that long ago left C# in the dust. I wonder if the future of C# lies in switching its home runtime from the CLR to JS.</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai3/">Poorly Structured Notes on AI Part 3</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>