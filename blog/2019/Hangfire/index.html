<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Hangfire - A Tale of Several Queues | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2019/Hangfire/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Hangfire - A Tale of Several Queues</h1> <p class="post-meta"> Created on May 24, 2019 </p> <p class="post-tags"> <a href="/blog/2019"> <i class="fa-solid fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/c"> <i class="fa-solid fa-hashtag fa-sm"></i> c#</a>   <a href="/blog/tag/hangfire"> <i class="fa-solid fa-hashtag fa-sm"></i> hangfire</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>If you’ve used <a href="https://www.hangfire.io/" rel="external nofollow noopener" target="_blank">Hangfire</a> you know it’s a really quick and easy way to give your app a queue of durable background jobs, with automatic retrying and a very nifty dashboard to let you see what’s happening right now. Jobs can trigger further jobs and so a complex series of processing stages can be decoupled and spill out into a queue of little units of work.</p> <p>You can setup one database (such as Redis) to store the state of all your jobs, and then multiple identical workers can attach to that database and munch through the jobs, taking them through the lifecycle:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Enqueued] -&gt; [Processing] -&gt; [Finished]
</code></pre></div></div> <p>Or maybe:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[Enqueued] -&gt; [Processing] -&gt; [Failed] -&gt; [Enqueued] -&gt; [Processing] -&gt; [Finished]
</code></pre></div></div> <p>It’s all good. Once enqueued, either the job finishes or you’ll be able to see it in the dashboard and read all the lovely exceptions.</p> <p>I recently hit the problem of having multiple tenants (totally separate customers in this case) executing jobs in the same Hangfire instance. This works fine until a low priority tenant floods the queue with jobs and stops higher priority work from getting done.</p> <h2 id="under-the-sea-analogy">Under-the-Sea Analogy</h2> <p>You run a service that washes sea creatures. A whale stopped by because he wants the krill cleaned out of his mouth and also his tail could use a service. It’s not that urgent though and you aren’t charging him as he’s a friend. You get started on that, but then a shark comes along (he happens to be one of your best customers) and he needs his teeth cleaned for a photo session starting in ten minutes. Oh no!</p> <p>What you need are two different queues, like a fast lane and slow lane. I could have just said it’s like a grocery shop with a “5 items or fewer” sign at the checkout, but I’ve already written all that stuff about the sea creatures and I’m not deleting it now.</p> <h2 id="hangfire-queues-and-their-limitations">Hangfire queues and their limitations</h2> <p>So how can Hangfire help us here? It has the concept of queues. When you start a “server” (nothing to do with a physical box or even a process: you can start multiple of them inside one process) you specify what queue(s) it will read from and how many dedicated worker threads it has. So you could start separate servers for <code class="language-plaintext highlighter-rouge">fast</code> and <code class="language-plaintext highlighter-rouge">slow</code>, each dedicated to their one queue.</p> <p>But there’s a problem. by design, Hangfire doesn’t assign jobs to queues. Rather, when a job is enqueued, a queue name such as <code class="language-plaintext highlighter-rouge">fast</code> can (optionally) be specified. The choice of queue is not stamped on the job, but stored as a property inside the state object representing the <code class="language-plaintext highlighter-rouge">Enqueued</code> state. This means that when the job transitions to <code class="language-plaintext highlighter-rouge">Processing</code> it will be picked up by the <code class="language-plaintext highlighter-rouge">fast</code> server, but now nothing is storing the queue name. Why is that a problem?</p> <p>Well, jobs fail sometimes, and they need to be retried. In fact this is part of what makes a system like Hangfire so valuable; occasional transient problems (a database glitch) don’t stop your work from getting done. But obviously when that happens to our jobs, we want them to be enqueued for their second attempt on the same queue as last time.</p> <h2 id="extension-points">Extension points</h2> <p>Hangfire supports several extension points, and the relevant ones here are:</p> <ul> <li>You can add your own custom properties to jobs. So it is possible to stamp the queue name on the job in a way that persists throughout its life.</li> <li>You can install a filter call a <code class="language-plaintext highlighter-rouge">IClientFilter</code> that lets you hook into the point where a job is created at the client, and get the queue name from its initial state and copy it into a custom property. This is the part that stashes the queue name.</li> <li>There’s another kind of filter called <code class="language-plaintext highlighter-rouge">IElectStateFilter</code> that lets you hook into the event of a job changing state. If it’s changing to the <code class="language-plaintext highlighter-rouge">Enqueued</code> state, you can copy the queue name from the custom property you stashed in the previous step and fix the state to have the queue name in it, thus forcing it into the right queue.</li> </ul> <p>By combining these we can basically brute-force jobs into running on the queue we’ve stamped them with.</p> <p>So the <code class="language-plaintext highlighter-rouge">IClientFilter</code> might look like this:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">QueueNameRecorder</span> <span class="p">:</span> <span class="n">IClientFilter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnCreating</span><span class="p">(</span><span class="n">CreatingContext</span> <span class="n">filterContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">enqueuedState</span> <span class="p">=</span> <span class="n">filterContext</span><span class="p">.</span><span class="n">InitialState</span> <span class="k">as</span> <span class="n">EnqueuedState</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">enqueuedState</span><span class="p">?.</span><span class="n">Queue</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">filterContext</span><span class="p">.</span><span class="nf">SetJobParameter</span><span class="p">(</span><span class="s">"stashedQueueName"</span><span class="p">,</span> <span class="n">enqueuedState</span><span class="p">.</span><span class="n">Queue</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnCreated</span><span class="p">(</span><span class="n">CreatedContext</span> <span class="n">filterContext</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>And in the start-up of your clients:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">GlobalJobFilters</span><span class="p">.</span><span class="n">Filters</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="k">new</span> <span class="nf">QueueNameRecorder</span><span class="p">());</span>
</code></pre></div></div> <p>This means that if we enqueue a job on the <code class="language-plaintext highlighter-rouge">fast</code> queue:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_backgroundJobs</span><span class="p">.</span><span class="n">Create</span><span class="p">&lt;</span><span class="n">Toothbrush</span><span class="p">&gt;(</span><span class="n">j</span> <span class="p">=&gt;</span> <span class="n">j</span><span class="p">.</span><span class="nf">CleanTeeth</span><span class="p">(),</span> <span class="k">new</span> <span class="nf">EnqueuedState</span><span class="p">(</span><span class="s">"fast"</span><span class="p">));</span>
</code></pre></div></div> <p>the above <code class="language-plaintext highlighter-rouge">OnCreating</code> handler will kick in and store the value <code class="language-plaintext highlighter-rouge">fast</code> in a custom property <code class="language-plaintext highlighter-rouge">stashedQueueName</code>, permanently associating the job with that queue.</p> <p>Meanwhile in the worker processes, you need the <code class="language-plaintext highlighter-rouge">IElectStateFilter</code>:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">QueueNameFixer</span> <span class="p">:</span> <span class="n">IElectStateFilter</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">void</span> <span class="nf">OnStateElection</span><span class="p">(</span><span class="n">ElectStateContext</span> <span class="n">context</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">queueName</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">GetJobParameter</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="s">"stashedQueueName"</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="p">.</span><span class="n">CandidateState</span><span class="p">.</span><span class="n">Name</span> <span class="p">==</span> <span class="s">"Enqueued"</span> <span class="p">&amp;&amp;</span>
            <span class="p">!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrWhiteSpace</span><span class="p">(</span><span class="n">queueName</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="n">context</span><span class="p">.</span><span class="n">CandidateState</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">EnqueuedState</span><span class="p">(</span><span class="n">queueName</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>… registered in <code class="language-plaintext highlighter-rouge">GlobalJobFilters</code> exactly the same way as before, but in worker processes. And <code class="language-plaintext highlighter-rouge">OnStateElection</code> will fire whenever any job is changing to any new state. Here we’re only interested in jobs that are becoming <code class="language-plaintext highlighter-rouge">Enqueued</code> and that have a <code class="language-plaintext highlighter-rouge">stashedQueueName</code>.</p> <p>What you then see in your Hangfire dashboard is a bit odd - the job will first be enqueued on the <code class="language-plaintext highlighter-rouge">DEFAULT</code> queue and then immediately enqueued a second time on the correct queue.</p> <p>Now you’re all set to clean a fish, or whatever it was I said before!</p> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai3/">Poorly Structured Notes on AI Part 3</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>