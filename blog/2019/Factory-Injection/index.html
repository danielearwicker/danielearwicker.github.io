<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Factory Injection in C# | Daniel Earwicker </title> <meta name="author" content="Daniel Earwicker"> <meta name="description" content="You are almost certainly lost on the Internet. "> <meta name="keywords" content="coding, physics"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?754e6b58bcf99910aed4f8d8638bd47f"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://danielearwicker.github.io/blog/2019/Factory-Injection/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Daniel</span> Earwicker </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Factory Injection in C#</h1> <p class="post-meta"> Created on July 02, 2019 </p> <p class="post-tags"> <a href="/blog/2019"> <i class="fa-solid fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/c"> <i class="fa-solid fa-hashtag fa-sm"></i> c#</a>   <a href="/blog/tag/injection"> <i class="fa-solid fa-hashtag fa-sm"></i> injection</a>   <a href="/blog/tag/factory"> <i class="fa-solid fa-hashtag fa-sm"></i> factory</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p><strong>Update</strong> - <em>There was a nasty bug in the original version of this post! Where I previously registered the factories with <code class="language-plaintext highlighter-rouge">AddSingleton</code>, I now use <code class="language-plaintext highlighter-rouge">AddTransient</code>, and I call out the reason for this below.</em></p> <p>The modern C# ecosystem (based on dotnet core, due to become .NET 5) enjoys a standard dependency injection system that is, despite its minimalism, is pretty much all you need.</p> <p>In some ways the ideal dependency injection system is nothing at all: isolate your components by writing an interface/class pair, and make each class accept interfaces to give it access to whatever services it needs. Very often the sole reason for the existence of the interface to go with each class is so that it can be mocked out in unit tests for classes that depend on it. (It’s worth noting that in languages based on dynamically typed runtimes there is typically no need to do this - it’s especially irksome to see this pattern being imported unnecessarily into TypeScript, where every class is <em>already</em> an interface.)</p> <p>Anyway, if all you have is “constructor injection”, and you set up a network of objects by constructing them, then there is no magic, no runtime resolution, any type errors are detected at compile time, and so you can’t forget to register something, because there’s no registering.</p> <p>But this is impractical in a large application; far more convenient to register each interface/class pair once in a <code class="language-plaintext highlighter-rouge">ServiceCollection</code>. The logic to build any given network of objects is automagically cooked up at runtime. It’s a deal with the devil; at the whole-application scale there is no longer any type checking. It’s a soup of components from which order emerges <em>if possible</em>.</p> <p>The dotnet core implementation of <code class="language-plaintext highlighter-rouge">ServiceCollection</code> also has the magic of allowing you to easily inject <code class="language-plaintext highlighter-rouge">IEnumerable&lt;IPen&gt;</code> to get an instance of every class registered as supporting <code class="language-plaintext highlighter-rouge">IPen</code>, enabling <a href="https://en.wikipedia.org/wiki/Strategy_pattern" rel="external nofollow noopener" target="_blank">the Strategy pattern</a>, which is hugely important.</p> <p>Another requirement that often crops up is to be able to inject into component <code class="language-plaintext highlighter-rouge">Artist</code> the ability to construct instances of a component <code class="language-plaintext highlighter-rouge">IPen</code> willy-nilly, rather than just receiving a single instance in <code class="language-plaintext highlighter-rouge">Artist</code>’s constructor. The obvious approach:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">interface</span> <span class="nc">IPenFactory</span>
<span class="p">{</span>
    <span class="n">IPen</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">colour</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">interface</span> <span class="nc">PenFactory</span> <span class="p">:</span> <span class="n">IPenFactory</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="n">IPen</span> <span class="nf">Create</span><span class="p">(</span><span class="kt">string</span> <span class="n">colour</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Pen</span><span class="p">(</span><span class="n">colour</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <p>Register that interface/class pair and you now have something you can inject to gain the ability to create as many pens as you want:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Artist</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">IPenFactory</span> <span class="n">_pens</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Artist</span><span class="p">(</span><span class="n">IPenFactory</span> <span class="n">pens</span><span class="p">)</span> <span class="p">{</span> <span class="n">_pens</span> <span class="p">=</span> <span class="n">pens</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Draw</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">pen</span> <span class="p">=</span> <span class="n">_pens</span><span class="p">.</span><span class="nf">Create</span><span class="p">(</span><span class="s">"red"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>The <code class="language-plaintext highlighter-rouge">Create</code> method takes a parameter, the string <code class="language-plaintext highlighter-rouge">colour</code>, so that the pen is bound to that colour at the moment of its creation (and presumably thereafter, assuming we’re being good and immutable).</p> <p>It gets a bit tedious having to churn out another interface/class pair every time you encounter this pattern. Fortunately we can eliminate the boilerplate. Recall Earwicker’s 158th Law:</p> <blockquote> <p>An interface with one (non-generic) method should be replaced by <code class="language-plaintext highlighter-rouge">Func</code>, even (or especially) if it confuses everyone.</p> </blockquote> <p>And gloriously you can register a <code class="language-plaintext highlighter-rouge">Func</code> as the “interface” part of a pair:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;&gt;(</span><span class="n">colour</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Pen</span><span class="p">(</span><span class="n">colour</span><span class="p">));</span>
</code></pre></div></div> <p>Such that, with no special classes:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Artist</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="k">readonly</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;</span> <span class="n">_createPen</span><span class="p">;</span>

    <span class="k">public</span> <span class="nf">Artist</span><span class="p">(</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;</span> <span class="n">createPen</span><span class="p">)</span>
    <span class="p">{</span>
         <span class="n">_createPen</span> <span class="p">=</span> <span class="n">createPen</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">void</span> <span class="nf">Draw</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="kt">var</span> <span class="n">pen</span> <span class="p">=</span> <span class="nf">_createPen</span><span class="p">(</span><span class="s">"purple"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>In real applications the equivalent of <code class="language-plaintext highlighter-rouge">Pen</code> is a service class that depends on other injectable services, as well as probably needing parameters (such as <code class="language-plaintext highlighter-rouge">colour</code>) from the client. Say there’s a singleton <code class="language-plaintext highlighter-rouge">IInkSupply</code> service that pens can dip into. This can be registered in the usual way with <code class="language-plaintext highlighter-rouge">AddSingleton</code>, and then we can give <code class="language-plaintext highlighter-rouge">Pen</code> two parameters:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">Pen</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nf">Pen</span><span class="p">(</span><span class="n">IInkSupply</span> <span class="n">ink</span><span class="p">,</span> <span class="kt">string</span> <span class="n">colour</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <p>How should we register <code class="language-plaintext highlighter-rouge">Pen</code>? We want to get the ink from the service provider (that is, magically plucked from the ether), and the colour from a formal parameter:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;&gt;(</span>
    <span class="n">services</span> <span class="p">=&gt;</span> <span class="n">colour</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="nf">Pen</span><span class="p">(</span><span class="n">services</span><span class="p">.</span><span class="n">GetRequiredService</span><span class="p">&lt;</span><span class="n">IInkSupply</span><span class="p">&gt;(),</span> <span class="n">colour</span><span class="p">));</span>
</code></pre></div></div> <p>This is using a different overload of <code class="language-plaintext highlighter-rouge">AddSingleton</code> from last time. Our outermost function receives a <code class="language-plaintext highlighter-rouge">IServiceProvider</code> (<code class="language-plaintext highlighter-rouge">services</code>) and it has to return <em>another</em> function that actually implements <code class="language-plaintext highlighter-rouge">Func&lt;string, IPen&gt;</code>.</p> <p>If you have a few services to throw into <code class="language-plaintext highlighter-rouge">Pen</code> besides the formal parameter(s), all the calls to <code class="language-plaintext highlighter-rouge">services.GetRequiredService&lt;IBlah&gt;()</code> become a burden. Besides, it’s not very injectiony to have to edit this gnarly registration every time you add a service dependency to <code class="language-plaintext highlighter-rouge">Pen</code>’s constructor.</p> <p>But there’s another magic facility to solve this:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddSingleton</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;&gt;(</span>
    <span class="n">services</span> <span class="p">=&gt;</span> <span class="n">colour</span> <span class="p">=&gt;</span> <span class="n">ActivatorUtilities</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">Pen</span><span class="p">&gt;(</span><span class="n">services</span><span class="p">,</span> <span class="n">colour</span><span class="p">));</span>
</code></pre></div></div> <p>Note that <code class="language-plaintext highlighter-rouge">CreateInstance</code> has to be given a constructable type (not an interface). It will construct it by matching parameters to arguments based on their types, and filling in the rest with registered services. Again, a deal with the devil in that we’ve lost a bit of static type checking.</p> <p>But there’s a nasty trapdoor lurking here that I didn’t spot in my original version of this post. We’re registering an injectable <code class="language-plaintext highlighter-rouge">Func</code> that we can then call with any parameters we like, as many times as we like, to get as many separate instances as we like. So it’s tempting to conclude that therefore we aren’t in danger of inadvertently capturing and permanently holding onto data. We’re building object instances on-the-fly, right?</p> <p>Well, not entirely. By registering the factory with <code class="language-plaintext highlighter-rouge">AddSingleton</code>, we cause DI to pass us the root service provider as the <code class="language-plaintext highlighter-rouge">services</code> argument. That’s the service provider that caches things <em>forever</em>. It doesn’t do this for transients, because they’re never cached. It does cache singletons, but that’s fine, because they have to be globally cached (so there’s only one instance). So if <code class="language-plaintext highlighter-rouge">Pen</code> injects transients or singletons (or other factories, which so far are singletons), we’re good.</p> <p>But there’s another form of registration: <em>scoped</em>. This is typically used for objects that carry information about a specific user session inside a server, and which should therefore be singleton-per-user, as it were. If <code class="language-plaintext highlighter-rouge">Pen</code> were to inject a scoped service, a problem arises.</p> <p>What happens next depends on how your root service provider is configured. If it is configured to validate scopes, then you’ll get <code class="language-plaintext highlighter-rouge">InvalidOperationException</code>, with the message <code class="language-plaintext highlighter-rouge">Cannot resolve scoped service 'Blah...' from root provider.</code> This is good - your DI environment is protecting you from a potentially terrible bug, where the first user’s data is captured in a scoped service and is then provided to all subsequent users, thus leaking information between users. If you don’t have that check enabled, that information leak could occur silently.</p> <p>The solution is to register functions with <code class="language-plaintext highlighter-rouge">AddTransient</code>. This causes DI to pass us a transient provider, which doesn’t cache anything scoped.</p> <p>So you can now sling new services into <code class="language-plaintext highlighter-rouge">Pen</code>’s constructor and not have touch the registration. It’s a bit ugly looking as registrations go. But we can hide this by creating a few reusable extension methods of our own:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">static</span> <span class="k">class</span> <span class="nc">FactoryExtensions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddFactory</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">,</span> <span class="n">TImplementation</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TImplementation</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">TInterface</span>
        <span class="k">where</span> <span class="n">TInterface</span> <span class="p">:</span> <span class="k">class</span> <span class="err">=&gt;</span> <span class="nc">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">&gt;&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="p">()</span>
                                        <span class="p">=&gt;</span> <span class="n">ActivatorUtilities</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">TImplementation</span><span class="p">&gt;(</span><span class="n">sp</span><span class="p">));</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddFactory</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">,</span> <span class="n">TImplementation</span><span class="p">,</span> <span class="n">TArg1</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TImplementation</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">TInterface</span>
        <span class="k">where</span> <span class="n">TInterface</span> <span class="p">:</span> <span class="k">class</span> <span class="err">=&gt;</span> <span class="nc">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg1</span><span class="p">,</span> <span class="n">TInterface</span><span class="p">&gt;&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="n">arg1</span>
                                        <span class="p">=&gt;</span> <span class="n">ActivatorUtilities</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">TImplementation</span><span class="p">&gt;(</span><span class="n">sp</span><span class="p">,</span> <span class="n">arg1</span><span class="p">));</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddFactory</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">,</span> <span class="n">TImplementation</span><span class="p">,</span> <span class="n">TArg1</span><span class="p">,</span> <span class="n">TArg2</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TImplementation</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">TInterface</span>
        <span class="k">where</span> <span class="n">TInterface</span> <span class="p">:</span> <span class="k">class</span> <span class="err">=&gt;</span> <span class="nc">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg1</span><span class="p">,</span> <span class="n">TArg2</span><span class="p">,</span> <span class="n">TInterface</span><span class="p">&gt;&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">)</span>
                                        <span class="p">=&gt;</span> <span class="n">ActivatorUtilities</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">TImplementation</span><span class="p">&gt;(</span><span class="n">sp</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">));</span>

    <span class="k">public</span> <span class="k">static</span> <span class="n">IServiceCollection</span> <span class="n">AddFactory</span><span class="p">&lt;</span><span class="n">TInterface</span><span class="p">,</span> <span class="n">TImplementation</span><span class="p">,</span> <span class="n">TArg1</span><span class="p">,</span> <span class="n">TArg2</span><span class="p">,</span> <span class="n">TArg3</span><span class="p">&gt;(</span><span class="k">this</span> <span class="n">IServiceCollection</span> <span class="n">services</span><span class="p">)</span>
        <span class="k">where</span> <span class="n">TImplementation</span> <span class="p">:</span> <span class="k">class</span><span class="err">,</span> <span class="nc">TInterface</span>
        <span class="k">where</span> <span class="n">TInterface</span> <span class="p">:</span> <span class="k">class</span> <span class="err">=&gt;</span> <span class="nc">services</span><span class="p">.</span><span class="n">AddTransient</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="n">TArg1</span><span class="p">,</span> <span class="n">TArg2</span><span class="p">,</span> <span class="n">TArg3</span><span class="p">,</span> <span class="n">TInterface</span><span class="p">&gt;&gt;(</span><span class="n">sp</span> <span class="p">=&gt;</span> <span class="p">(</span><span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">)</span>
                                        <span class="p">=&gt;</span> <span class="n">ActivatorUtilities</span><span class="p">.</span><span class="n">CreateInstance</span><span class="p">&lt;</span><span class="n">TImplementation</span><span class="p">&gt;(</span><span class="n">sp</span><span class="p">,</span> <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span><span class="p">,</span> <span class="n">arg3</span><span class="p">));</span>
<span class="p">}</span>
</code></pre></div></div> <p>So those variants support between 0 and 3 type parameters in addition to the first two (interface and class). So registering a <code class="language-plaintext highlighter-rouge">Func&lt;string, IPen&gt;</code> is as simple as:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">services</span><span class="p">.</span><span class="n">AddFactory</span><span class="p">&lt;</span><span class="n">IPen</span><span class="p">,</span> <span class="n">Pen</span><span class="p">,</span> <span class="kt">string</span><span class="p">&gt;();</span>
</code></pre></div></div> <p>If you need more than that then you should probably define a wrapper type containing all the parameters as properties and pass that as the only parameter (this is often a good idea anyway, but is essential when the only criterion for matching arguments to parameters is assignment compatibility - what if you need to pass two different strings?)</p> <p>By the way, if you haven’t tried injecting <code class="language-plaintext highlighter-rouge">Func</code> before, you may be worried about whether your mocking framework will still work with this approach. I can vouch for Moq, which deals with it beautifully:</p> <div class="language-cs highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">var</span> <span class="n">createPen</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">Func</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">,</span> <span class="n">IPen</span><span class="p">&gt;&gt;();</span>
<span class="kt">var</span> <span class="n">greenPen</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Mock</span><span class="p">&lt;</span><span class="n">IPen</span><span class="p">&gt;();</span>

<span class="n">createPen</span><span class="p">.</span><span class="nf">Setup</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="s">"green"</span><span class="p">)).</span><span class="nf">Returns</span><span class="p">(</span><span class="n">greenPen</span><span class="p">.</span><span class="n">Object</span><span class="p">);</span>

<span class="k">new</span> <span class="nf">Artist</span><span class="p">(</span><span class="n">CreatePen</span><span class="p">).</span><span class="nf">Draw</span><span class="p">();</span>

<span class="n">createPen</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="n">c</span> <span class="p">=&gt;</span> <span class="nf">c</span><span class="p">(</span><span class="s">"puce"</span><span class="p">),</span> <span class="n">Times</span><span class="p">.</span><span class="n">Never</span><span class="p">);</span>
</code></pre></div></div> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Not yet regretting the time you've spent here?</h2> <p class="mb-2">Keep reading:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai3/">Poorly Structured Notes on AI Part 3</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai2/">Poorly Structured Notes on AI Part 2</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ai1/">Poorly Structured Notes on AI Part 1</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2024/Prompt-Engineer/">How to become a prompt engineer</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2023/Time-reversible-events/">Time reversible events</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Daniel Earwicker. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>